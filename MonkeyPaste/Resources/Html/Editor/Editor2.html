<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title>Yo this is a title</title>
    <link href="https://cdn.quilljs.com/2.0.0-dev.4/quill.snow.css"
          rel="stylesheet" />
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.2/styles/github.min.css" />
    <link type="text/css" href="https://unpkg.com/quill-better-table@1.2.7/dist/quill-better-table.css" rel="stylesheet" />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.2/highlight.min.js"></script>
    <script charset="UTF-8"
            src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.2/languages/xml.min.js"></script>
    <script src="https://cdn.quilljs.com/2.0.0-dev.4/quill.min.js"></script>


    <script src="https://cdn.quilljs.com/2.0.0-dev.3/quill.js"></script>
    <script src="https://unpkg.com/quill-better-table@1.2.8/dist/quill-better-table.min.js"></script>
    <link type="text/css" href="https://cdn.quilljs.com/2.0.0-dev.3/quill.snow.css" rel="stylesheet">
    <link type="text/css" href="https://unpkg.com/quill-better-table@1.2.7/dist/quill-better-table.css" rel="stylesheet" />

    <script src="https://unpkg.com/quill-better-table@1.2.8/dist/quill-better-table.min.js"></script>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>

    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script src="https://cdn.jsdelivr.net/gh/T-vK/DynamicQuillTools@master/DynamicQuillTools.js"></script>

    <style>
        body {
            margin: 0px;
            padding: 0px;
            font-family: Arial;
        }

        .btn {
            border: none;
            background-color: green;
            padding: 14px 28px;
            font-size: 16px;
            cursor: pointer;
            display: inline-block;
        }

            /* On mouse-over */
            .btn:hover {
                background: #eee;
            }

        .success {
            color: green;
        }

        #editor {
            width: 100%;
            height: auto;
        }

        .ql-toolbar {
            width: 100%;
        }

        .ql-templatebutton:after {
            /*/content: "§";*/
            height: 15px;
            width: 15px;
            background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAOEAAADhCAMAAAAJbSJIAAAAaVBMVEX/////wQf/vwD/24f/3Iz///3/vQD/ykL/yTj/yT3/0WH/0F7/0Fv/y0T/y0f/yTr/35T/wxT/8tP/6Lj/5az/7sj/9uX/46P/1G7/677/57P/2oL/xSj/8M//1nj//fb//O//4Zz/zVBsBjAmAAAEzklEQVR4nO2di3qiMBBGIUpa1168tFZ70933f8hl0KqVWCuZyfzhm/MAfJ7vhAmwCy0KwzAMwzAMwzAMwzAMwzAMWKq3QSzDyXymrXGe6ta7eLwvl8/aKmGqW1fy4Pz0SdsmAJ9g4zhaaAudwirYOIJl5Bas8QNtqWMEBLEURQRrRZiFKiRYK4KMGzHB0j1ouzXICdYR59p2haxg6d619YQF64gfPRcs3ae24KOsYOmmyoLCBUvtDSOBYOk176TEl2hjqHhdw1WwvuetOXcsN9ET5Cno/PJ1tvh4Gp9xdEM1QZ6C/m29O+Dmj4cyZCroV0fHfAkpahlyFfw+KEOKSoZcBU9//bh9WB1Dtn3w9MCbdkQVQ7Ztov3j71pH1jBk2+h9++n2UyuigiHfpZrftA7+AWDIeKnm162jL/QNOS+2Aw1n6oasF9uB83Cubch7uxS4qF4qz9JqxHq71L5/Xyvvh+z3g/40YjthUkOBG96TM7F9FiY1ZF6i25/vjhVXuvcWUv/4sl+o60/d+0OJglvF6XC2WS+eP53uPb7gUzV34TlNGkOxgpdJY5jiuaiqoWLBNIZJHvxqGuoKJjBUXaIpDDWHTBJD7YLihuoFxQ3VCwob6i9RacMbAEFJwwpCUNIQQ1DOEKSgoCHCkGkQMoQpKGUIsU3skDHEKShjiFRQxhCpoIQh0JBp4DcEE2Q3RCvIbwg1ZBp4DfEKMhtibRM7WA3vAQU5DRGXaMlqCFmQ0RC0IKMhqiCXYQW6REs2Q9iCXIa4BZkMgQvyGCIX5DCE3SZ2xBtiF4w3RC8YbwgvGGkIvNHviTPELxhpmEHBOMMcCkYZPmQh2H77q2cFS/dQ9bugu+laMIshE/Ntk1wEOxccB//POBzdC75lInjfVfC574LFNIuTMOIDSn+zSNh9yBRV3wsWrzkkjCgYeh8cj6iPmOWwSKMKBl4lhsPdd73YbsA/DeMKFsUEfZW6m6iCRTEAN4y4ksnDMLog+iqNLxh+XRqG2CHTgLxbcBSE3vFZChbBTzFhELnRH0A9EbkK1mirhGHYJvYEv/umDc+Q+eId70zkLFggbhi8BWsmYIqMQ+aLJZQie0EC6aG3GwkIFkX4W6EaMA8ZPEWBc/ALjIUqVpBAqChYkLhTV3QjwYKEdkXhgoRuRfGChGZF0SFzQG+iCm30bbQqJiqop5hgyBzQWKgJCxLpKyYtSKTeNJJsE99JWzF5QSJlRYWCRLqKiYfMgVQT1d0qCaaqqLRE0ym6R0XBFAtVWVC+ouoS3SK7aSgOmQOSFQEKEnIVIQoSUhVBChIyExWmICFREaggwa+ovg+ewr1Q4QS5K4It0S2cmwbUkDnAVxGyIMFVEbQgwVMRcMgc4JiowAWJ+IrQBYlYRfCCRNxCzUAwriL8Et3SfdPIoiDRtWImBYluFbMpSHSpmFFB4vqJmlVB4tqKmRUkrlPMriBxzULNUvCaihku0S2/3TQyLUj8rmK2BYnfVMy4IHG5YuaClydq9oKXKvZA8GfFXgj+tFB7Inj+hSLf+btqcEyCf7nXL7V/FyOz91ZGX660fxUvL+VxR+fdpDcrdM9q7Lx3jv7gtPv32j8/oprNJ8PB5HXWTz3DMAzDMAzDMAzDMAzDMHrEf9VjaGNa1FYRAAAAAElFTkSuQmCC");
        }

        /* maps font sizes to font drop down*/
        .ql-snow
        .ql-picker.ql-size
        .ql-picker-label[data-value]::before,
        .ql-snow .ql-picker.ql-size
        .ql-picker-item[data-value]::before {
            content: attr(data-value) !important;
        }

        /* Table Styles*/
        .ql-snow .ql-Table-Input .ql-picker-options {
            padding: 3px 5px;
            width: 152px;
        }

        .ql-editor {
            height: auto;
            padding: 2px 10px;
        }

        .ql-snow .ql-Table-Input .ql-picker-item {
            border: 1px solid transparent;
            float: left;
            height: 16px;
            margin: 2px;
            padding: 0px;
            width: 16px;
            background: lightsteelblue;
        }

            .ql-snow .ql-Table-Input .ql-picker-item:hover, .ql-snow .ql-Table-Input .ql-picker-item.ql-picker-item-highlight {
                border-color: #000;
                background: steelblue;
            }

        .ql-snow .ql-Table-Input.ql-picker {
            width: 28px;
        }

            .ql-snow .ql-Table-Input.ql-picker .ql-picker-label {
                padding: 2px 4px;
            }

        /* Template Button */
        .template_btn {
            display: inline;
            padding: 1px;
            text-decoration: none;
            color: #67c5ff;
            border-radius: 3px;
            transition: .4s;
            margin: 0 1px;
        }

            .template_btn:hover {
                padding: 3px;
                transition: .2s;
                cursor: pointer;
            }


        .selectedTemplate {
        }

        /* Template Context Menu*/
        .cls-context-menu-link {
            display: block;
            padding: 20px;
            background: #ECECEC;
        }

        .cls-context-menu {
            position: absolute;
            display: none;
        }

            .cls-context-menu ul,
            #context-menu li {
                list-style: none;
                margin: 0;
                padding: 0;
                background: white;
            }

        .cls-context-menu {
            border: solid 1px #CCC;
        }

            .cls-context-menu li {
                border-bottom: solid 1px #CCC;
            }

                .cls-context-menu li:last-child {
                    border: none;
                }

                .cls-context-menu li a {
                    display: block;
                    padding: 5px 10px;
                    text-decoration: none;
                    color: blue;
                }

                    .cls-context-menu li a:hover {
                        background: blue;
                        color: #FFF;
                    }

        /* Paste Template Toolbar */
        .paste-template-toolbar {
            display: none;
            width: 100%;
            background-color: lightyellow;
            border: solid 1px yellow;
            padding: 5px 10px;
        }

        .paste-template-toolbar-btn {
            display: inline-block;
            padding: 2px 5px;
            text-decoration: none;
            font-size:14px;
            border: 1px solid #CCC;
            color: white;
            border: solid 2px #67c5ff;
            border-radius: 7px;
            transition: .4s;
            margin: 0 5px;
            background-color: dodgerblue;
            cursor: pointer;
        }

        .paste-template-toolbar-btn:hover {
            color:dimgray;
            transition: .4s; 
            cursor: pointer;
        }

        /* Custom Selector style*/
        .Select-menu-outer {
            top: auto;
            bottom: 100%
        }

        .custom-select {
            display: inline-block;
            position: relative;
            font-family: Arial;
        }

            .custom-select select {
                display: none;
            }

        .select-selected {
            background-color: DodgerBlue;
        }

        .select-selected-item {
            background-color: lightblue;
        }

        .select-selected:before {
            position: absolute;
            content: "";
            top: 7px;
            left: 5px;
            width: 0;
            height: 0;
            border: 6px solid transparent;
            border-color: #fff transparent transparent transparent;
        }

        .select-selected.select-arrow-active:before {
            border-color: transparent transparent #fff transparent;
            top: 10px;
        }

        .select-items div,
        .select-selected {
            color: #ffffff;
            padding: 12px 5px;
            border: 1px solid transparent;
            border-color: transparent transparent rgba(0, 0, 0, 0.1) transparent;
            cursor: pointer;
            user-select: none;
        }

        .select-items {
            position: absolute;
            background-color: DodgerBlue;
            top: 100%;
            left: 0;
            right: 0;
            z-index: 99;
        }

        .select-hide {
            display: none;
        }

        .select-items div:hover,
        .same-as-selected {
            background-color: rgba(0, 0, 0, 0.1);
        }

        .select-items .square-box {
            height: 18px;
            width: 18px;
            float: left;
            margin: 0 20px 0 20px;
        }

        .select-selected .square-box {
            height: 18px;
            width: 18px;
            position: absolute;
            margin: 0 20px 0 20px;
        }
    </style>
</head>
<body>

    <div id='editor'>
    </div>

    <div id="templateToolbarMenu" class="cls-context-menu">
        <ul id="templateToolbarMenuList">
        </ul>
    </div>
    <div id="pasteTemplateToolbar" class="paste-template-toolbar">
        <div id="custom-select" class="custom-select" style="min-width:160px;">
            <select id="pasteTemplateToolbarMenuSelector">
            </select>
        </div>
        <div id="clearAllTemplateTextButton" tabindex="0" class="paste-template-toolbar-btn">
            <span>CLEAR ALL</span>
        </div>
        <div style="display:inline-block">
            <input id="templateTextArea" tabindex="1" onchange="templateTextAreaChange()" onkeyup="templateTextAreaChange()" onsearch="templateTextAreaChange()" type="search" cols="30" />
        </div>
        <div id="previousTemplateButton" tabindex="2" class="paste-template-toolbar-btn">
            <span>◄</span>
        </div>
        <div id="nextTemplateButton" tabindex="3" class="paste-template-toolbar-btn">
            <span>►</span>
        </div>
        <div id="pasteTemplateButton" tabindex="4" class="paste-template-toolbar-btn">
            <span>FINISH</span>
        </div>
    </div>

    <script src="https://cdn.polyfill.io/v2/polyfill.min.js?features=Promise"
            crossorigin="anonymous"></script>
    <script src="https://benwinding.github.io/quill-html-edit-button/dist/quill.htmlEditButton.min.js"></script>
    <script type="text/javascript">
        var curQuillDiv = $("#editor");
        var quill;
        var isShowingTemplateMenu = false;
        var clickCount = 0;
        var selectedTemplateId = 0;
        var wasLastClickOnTemplate = false;
        var isCompleted = false;
        var isLoaded = false;
        var isPastingTemplate = false;
        var isShowingPasteTemplateToolbar = false;
        var isShowingToolbar = true;
        var htmlContent = "[{\"templateId\":\"-1\",\"templateName\":\"Template #1\",\"templateColor\":\"#402A32\",\"docIdx\":[\"0\",\"3\",\"8\",\"35\"],\"templateText\":\"Template #1\"},{\"templateId\":\"-2\",\"templateName\":\"Template #2\",\"templateColor\":\"#D78484\",\"docIdx\":[\"2\",\"9\",\"32\"],\"templateText\":\"Template #2\"},{\"templateId\":\"-3\",\"templateName\":\"Template #3\",\"templateColor\":\"#165FA4\",\"docIdx\":\"4\",\"templateText\":\"Template #3\"},{\"templateId\":\"-4\",\"templateName\":\"Template #4\",\"templateColor\":\"#912505\",\"docIdx\":\"38\",\"templateText\":\"Template #4\"}]";
        /*
         * var myArray = {id1: 100, id2: 200, "tag with spaces": 300};
            myArray.id3 = 400;
            myArray["id4"] = 500;
            You can loop through it using for..in loop:

            for (var key in myArray) {
              console.log("key " + key + " has value " + myArray[key]);
            }
            */

        function init(html, fontFamilys, fontSizes, defaultFontIdx, indentSize, isFillingTemplates) {
            if (fontFamilys == null) {
                fontFamilys = ['Arial', 'Courier', 'Garamond', 'Tahoma', 'Times New Roman', 'Verdana'];
            }
            if (fontSizes == null) {
                fontSizes = ['8px', '9px', '10px', '12px', '14px', '16px', '20px', '24px', '32px', '42px', '54px', '68px', '84px', '98px'];
            }
            if (defaultFontIdx == null) {
                defaultFontIdx = 0;
            }
            loadQuill(fontFamilys, fontSizes, defaultFontIdx);

            isPastingTemplate = isFillingTemplates;

            //html = "sdlikfjsdlkfj sdlfikjsdl;kfj {{5,Pokemon,#808080}}                 {{5,Pokemon,#808080}}      {{7,Pokemon334,#AA4433}}              {{3,Pokemon,#FF22BB}}";
            //moveToolbarTop(0);

            if(htmlContent != null) {
                //setContents(htmlContent);
            }
            if (html != null) {
                setHtml(html);
            }            

            if (isFillingTemplates) {
                showPasteTemplateToolbar();
            }

            isLoaded = true;
        }

        function registerTables() {
            var tableOptions = [];
            var maxRows = 7;
            var maxCols = 7;

            for (let r = 1; r <= maxRows; r++) {
                for (let c = 1; c <= maxCols; c++) {
                    tableOptions.push('newtable_' + r + '_' + c);
                }
            }
            return tableOptions;
        }

        function registerToolbar(fontFamilys, fontSizes, defaultFontIdx) {
            var fonts = registerFonts(fontFamilys);

            var toolbarOptions = [
                //[{ 'size': ['small', false, 'large', 'huge'] }],  // custom dropdown
                [{ 'size': fontSizes }],               // font sizes
                [{ 'font': fonts.whitelist }],
                ['bold', 'italic', 'underline'/*, 'strike'*/],        // toggled buttons
                //['blockquote', 'code-block'],

                // [{ 'header': 1 }, { 'header': 2 }],               // custom button values
                [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                // [{ 'script': 'sub' }, { 'script': 'super' }],      // superscript/subscript
                [{ 'indent': '-1' }, { 'indent': '+1' }],          // outdent/indent
                //[{ 'direction': 'rtl' }],                         // text direction

                // [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
                ['link', 'image', 'video', 'formula'],
                [{ 'color': [] }, { 'background': [] }],          // dropdown with defaults from theme
                [{ 'align': [] }],
                // ['clean'],                                         // remove formatting button
                // ['templatebutton'],
                [{ 'Table-Input': registerTables() }]
            ];

            return toolbarOptions;
        }

        function registerFonts(fontFamilys, fontSizes, defaultFontIdx) {
            // Specify Quill fonts
            var fontNames = fontFamilys.map(font => getFontName(font));
            var fonts = Quill.import('attributors/class/font');
            fonts.whitelist = fontNames;
            Quill.register(fonts, true);

            //font sizes
            var size = Quill.import('attributors/style/size');
            size.whitelist = fontSizes;
            Quill.register(size, true);

            return fonts;
        }

        function registerFontStyles(fontFamilys) {
            // Add fonts to CSS style
            var fontStyles = "";
            fontFamilys.forEach(function (font) {
                var fontName = getFontName(font);
                fontStyles += ".ql-snow .ql-picker.ql-font .ql-picker-label[data-value=" + fontName + "]::before, .ql-snow .ql-picker.ql-font .ql-picker-item[data-value=" + fontName + "]::before {" +
                    "content: '" + font + "';" +
                    "font-family: '" + font + "', sans-serif;" +
                    "}" +
                    ".ql-font-" + fontName + "{" +
                    " font-family: '" + font + "', sans-serif;" +
                    "}";
            });

            return fontStyles;
        }

        function registerTemplateSpan() {
            const Parchment = Quill.imports.parchment;
            const Delta = Quill.imports.delta;

            class TemplateSpan extends Parchment.EmbedBlot {
                static create(value) {
                    const node = super.create(value);
                    var textColor = isBright(value.templateColor) ? 'black' : 'white';
                    node.contentEditable = 'false';
                    node.innerText = value.templateName;
                    node.setAttribute('templateName', value.templateName);
                    node.setAttribute('templateColor', value.templateColor);
                    node.setAttribute('templateId', value.templateId);
                    node.setAttribute('docIdx',value.docIdx)
                    node.setAttribute('class', 'template_btn');
                    node.setAttribute('style', 'background-color: ' + value.templateColor + ';color:' + textColor + ';');
                    node.addEventListener('click', function (e) {
                        wasLastClickOnTemplate = true;
                        selectTemplate(value.templateId, false);
                    });
                    //this._addRemovalButton(node);
                    return node;
                }

                static value(domNode) {
                    return {
                        docIdx: domNode.getAttribute('docIdx'),
                        templateId: domNode.getAttribute('templateId'),
                        templateName: domNode.getAttribute('templateName'),
                        templateColor: domNode.getAttribute('templateColor'),
                    }
                }

                static _addRemovalButton(node) {
                    const button = document.createElement('button');
                    button.innerText = 'x';
                    button.onclick = () => node.remove();
                    button.contentEditable = 'false';
                    node.appendChild(button);

                    // Extra span forces the cursor to the end of the label, otherwise it appears inside the removal button
                    const span = document.createElement('span');
                    span.innerText = ' ';
                    node.appendChild(span);
                }
            }
            TemplateSpan.blotName = 'templatespan';
            TemplateSpan.tagName = 'SPAN';
            TemplateSpan.className = 'ql-templatespan';

            Quill.register(TemplateSpan);
        }

        function loadQuill(fontFamilys, fontSizes, defaultFontIdx, indentSize) {
            if (isLoaded) {
                return;
            }
            Quill.register("modules/htmlEditButton", htmlEditButton);
            Quill.register({ 'modules/better-table': quillBetterTable }, true);

            registerTemplateSpan();

            // Append the CSS stylesheet to the page
            var node = document.createElement('style');
            node.innerHTML = registerFontStyles(fontFamilys);
            document.body.appendChild(node);

            quill = new Quill(curQuillDiv[0], {
                placeholder: '',
                theme: 'snow',
                modules: {
                    toolbar: registerToolbar(fontFamilys, fontSizes, defaultFontIdx),
                    htmlEditButton: {
                        syntax: true,
                    },
                    table: false,
                    'better-table': {
                        operationMenu: {
                            items: {
                                unmergeCells: {
                                    text: 'Unmerge cells'
                                }
                            },
                            color: {
                                colors: ['green', 'red', 'yellow', 'blue', 'white'],
                                text: 'Background Colors:'
                            }
                        }
                    },
                    keyboard: {
                        bindings: quillBetterTable.keyboardBindings
                    }
                }
            });

            var curTableIconSpan = curQuillDiv.parent().find('span.ql-Table-Input.ql-picker')[0].childNodes[0];
            curTableIconSpan.innerHTML = "<svg style=\"right: 4px;\" viewbox=\"0 0 18 18\"> <rect class=ql-stroke height=12 width=12 x=3 y=3></rect> <rect class=ql-fill height=2 width=3 x=5 y=5></rect> <rect class=ql-fill height=2 width=4 x=9 y=5></rect> <g class=\"ql-fill ql-transparent\"> <rect height=2 width=3 x=5 y=8></rect> <rect height=2 width=4 x=9 y=8></rect> <rect height=2 width=3 x=5 y=11></rect> <rect height=2 width=4 x=9 y=11></rect> </g> </svg>";
            var curTableCellIconSpans = $(curTableIconSpan.parentNode.childNodes[1]).children();
            curTableCellIconSpans.click((function () {
                var curQuillBetterTable = quill.getModule('better-table');
                var curQuillToolbar = quill.getModule('toolbar');
                return function () {
                    var curRowIndex = Number(this.dataset.value.substring(9).split('_')[0]);
                    var curColIndex = Number(this.dataset.value.substring(9).split('_')[1]);
                    curQuillBetterTable.insertTable(curRowIndex, curColIndex);
                    // The following two lines have been added, thinking that it would fix the issue of keeping the icon in blue color.  However Quill keeps adding the classes back, so this fix doesn't work.
                    $(this).parent().parent().find(".ql-selected").removeClass("ql-selected"); $(this).parent().parent().find(".ql-active").removeClass("ql-active");
                };
            })());
            curTableCellIconSpans.hover(function () {
                var curRowIndex = Number(this.dataset.value.substring(9).split('_')[0]);
                var curColIndex = Number(this.dataset.value.substring(9).split('_')[1]);
                $(this).parent().children().each((function () {
                    var curRowIndex1 = curRowIndex;
                    var curColIndex1 = curColIndex;
                    return function () {
                        var curRowIndex2 = Number(this.dataset.value.substring(9).split('_')[0]);
                        var curColIndex2 = Number(this.dataset.value.substring(9).split('_')[1]);
                        if (curRowIndex2 <= curRowIndex1 && curColIndex2 <= curColIndex1) {
                            $(this).addClass("ql-picker-item-highlight");
                        }
                    };
                })());
            }, function () {
                $(this).parent().children().removeClass("ql-picker-item-highlight");
            });

            // Add a custom Button to the Quill Editor's toolbar:
            const templateToolbarButton = new QuillToolbarButton({
                icon: '<img id="templateToolbarButton" style="height:20px" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAOEAAADhCAMAAAAJbSJIAAAAaVBMVEX/////wQf/vwD/24f/3Iz///3/vQD/ykL/yTj/yT3/0WH/0F7/0Fv/y0T/y0f/yTr/35T/wxT/8tP/6Lj/5az/7sj/9uX/46P/1G7/677/57P/2oL/xSj/8M//1nj//fb//O//4Zz/zVBsBjAmAAAEzklEQVR4nO2di3qiMBBGIUpa1168tFZ70933f8hl0KqVWCuZyfzhm/MAfJ7vhAmwCy0KwzAMwzAMwzAMwzAMwzAMWKq3QSzDyXymrXGe6ta7eLwvl8/aKmGqW1fy4Pz0SdsmAJ9g4zhaaAudwirYOIJl5Bas8QNtqWMEBLEURQRrRZiFKiRYK4KMGzHB0j1ouzXICdYR59p2haxg6d619YQF64gfPRcs3ae24KOsYOmmyoLCBUvtDSOBYOk176TEl2hjqHhdw1WwvuetOXcsN9ET5Cno/PJ1tvh4Gp9xdEM1QZ6C/m29O+Dmj4cyZCroV0fHfAkpahlyFfw+KEOKSoZcBU9//bh9WB1Dtn3w9MCbdkQVQ7Ztov3j71pH1jBk2+h9++n2UyuigiHfpZrftA7+AWDIeKnm162jL/QNOS+2Aw1n6oasF9uB83Cubch7uxS4qF4qz9JqxHq71L5/Xyvvh+z3g/40YjthUkOBG96TM7F9FiY1ZF6i25/vjhVXuvcWUv/4sl+o60/d+0OJglvF6XC2WS+eP53uPb7gUzV34TlNGkOxgpdJY5jiuaiqoWLBNIZJHvxqGuoKJjBUXaIpDDWHTBJD7YLihuoFxQ3VCwob6i9RacMbAEFJwwpCUNIQQ1DOEKSgoCHCkGkQMoQpKGUIsU3skDHEKShjiFRQxhCpoIQh0JBp4DcEE2Q3RCvIbwg1ZBp4DfEKMhtibRM7WA3vAQU5DRGXaMlqCFmQ0RC0IKMhqiCXYQW6REs2Q9iCXIa4BZkMgQvyGCIX5DCE3SZ2xBtiF4w3RC8YbwgvGGkIvNHviTPELxhpmEHBOMMcCkYZPmQh2H77q2cFS/dQ9bugu+laMIshE/Ntk1wEOxccB//POBzdC75lInjfVfC574LFNIuTMOIDSn+zSNh9yBRV3wsWrzkkjCgYeh8cj6iPmOWwSKMKBl4lhsPdd73YbsA/DeMKFsUEfZW6m6iCRTEAN4y4ksnDMLog+iqNLxh+XRqG2CHTgLxbcBSE3vFZChbBTzFhELnRH0A9EbkK1mirhGHYJvYEv/umDc+Q+eId70zkLFggbhi8BWsmYIqMQ+aLJZQie0EC6aG3GwkIFkX4W6EaMA8ZPEWBc/ALjIUqVpBAqChYkLhTV3QjwYKEdkXhgoRuRfGChGZF0SFzQG+iCm30bbQqJiqop5hgyBzQWKgJCxLpKyYtSKTeNJJsE99JWzF5QSJlRYWCRLqKiYfMgVQT1d0qCaaqqLRE0ym6R0XBFAtVWVC+ouoS3SK7aSgOmQOSFQEKEnIVIQoSUhVBChIyExWmICFREaggwa+ovg+ewr1Q4QS5K4It0S2cmwbUkDnAVxGyIMFVEbQgwVMRcMgc4JiowAWJ+IrQBYlYRfCCRNxCzUAwriL8Et3SfdPIoiDRtWImBYluFbMpSHSpmFFB4vqJmlVB4tqKmRUkrlPMriBxzULNUvCaihku0S2/3TQyLUj8rmK2BYnfVMy4IHG5YuaClydq9oKXKvZA8GfFXgj+tFB7Inj+hSLf+btqcEyCf7nXL7V/FyOz91ZGX660fxUvL+VxR+fdpDcrdM9q7Lx3jv7gtPv32j8/oprNJ8PB5HXWTz3DMAzDMAzDMAzDMAzDMHrEf9VjaGNa1FYRAAAAAElFTkSuQmCC"></img>'//`<svg viewBox="0 0 18 18"> <path class="ql-stroke" d="M5,3V9a4.012,4.012,0,0,0,4,4H9a4.012,4.012,0,0,0,4-4V3"></path></svg>`
            })

            templateToolbarButton.onClick = function (e) {
                var templateButton = document.getElementById('templateToolbarButton');
                var tl = getTemplates();
                if (tl.length > 0) {
                    showTemplateContextMenu(templateButton);
                } else {
                    createTemplate();
                }
            }
            templateToolbarButton.attach(quill)

            document.addEventListener('click', function (e) {
                if (isShowingTemplateMenu && clickCount > 0) {
                    hideTemplateContextMenu();
                } else {
                    clickCount++;
                    if (!wasLastClickOnTemplate) {
                        clearTemplateSelection();
                        //hidePasteTemplateToolbar();
                    } else if (!isShowingPasteTemplateToolbar) {
                        //showPasteTemplateToolbar();
                    }
                    wasLastClickOnTemplate = false;
                }
                return;
            });

            quill.on('selection-change', function (range, oldRange, source) {
                if (range) {
                    if (range.length == 0) {
                        console.log('User cursor is on', range.index);
                    } else {
                        var text = quill.getText(range.index, range.length);
                        console.log('User has highlighted', text);
                    }

                } else {
                    console.log('Cursor not in the editor');
                }
            });

            //quill.on('text-change', function (delta, oldDelta, source) {
            //    var retainVal = 0;
            //    var textDelta = 0;
            //    var wasAddTemplate = false;
            //    delta.ops.forEach(function (op) {
            //        if(op.insert != null && op.insert.templatespan != null) {
            //            //handle shifting in create template
            //            wasAddTemplate = true;
            //            return;
            //        }
            //        if(op.retain != null) {
            //            retainVal = op.retain;
            //        }
            //        if(op.insert != null && op.insert.templatespan == null) {
            //            textDelta += op.insert.length;
            //        }
            //        if(op.delete != null) {
            //            textDelta -= parseInt(op.delete);
            //        }
            //    });
            //    if(!wasAddTemplate && textDelta != 0 && retainVal >= 0) {
            //        shiftTemplates(retainVal, textDelta);
            //        console.log(getTemplates());
            //    } 
                
            //});
        }

        function shiftTemplates(fromDocIdx, byVal) {
            var tl = getTemplates();
            tl.forEach(function (t) {
                if(Array.isArray(t.docIdx)) {
                    t.docIdx.forEach(function (tDocIdx) {
                        if(tDocIdx >= fromDocIdx) {
                            setTemplateDocIdx(t, tDocIdx, parseInt(parseInt(tDocIdx) + parseInt(byVal)));
                        }
                    });
                } else {
                    if(parseInt(t.docIdx) >= fromDocIdx) {
                        setTemplateDocIdx(t, t.docIdx, parseInt(parseInt(t.docIdx) + parseInt(byVal)));
                    }
                }
            });
        }

        function loadTemplates() {
            var html = getHtml();
            var idx = 0;
            var lenDiff = 0;
            while(true) {
                if(idx >= html.length) {
                    break;
                }
                var tt = findNextTemplateToken(idx+lenDiff,html);
                if(tt == null) {
                    break;
                }
                var ttIdx = tt.sIdx;
                var ttLen = tt.length;
                delete tt.sIdx;
                delete tt.length;
                idx = createTemplate(tt, idx, ttLen);
                lenDiff = getHtml().length - html.length + ttLen;
                html = getHtml();
            }
        }

        function findNextTemplateToken(fIdx, text, sToken = '{{', eToken = '}}', sep = ',') {
            text = text.substring(fIdx);
            var tsIdx = text.indexOf(sToken);
            var teIdx = text.indexOf(eToken);

            if (tsIdx < 0 || teIdx < 0) {
                return null;
            }

            var templateSpan = text.substring(tsIdx + sToken.length, teIdx);
            var templateParts = templateSpan.split(sep);

            if(templateParts.length != 3) {
                return null;
            }
            return {
                templateId: templateParts[0],
                templateName: templateParts[1],
                templateColor: templateParts[2],
                sIdx: fIdx + tsIdx,
                length: teIdx - tsIdx + eToken.length
            };
        }

        function createTemplate(templateObjOrId, idx, len) {
            var templateObj = templateObjOrId;
            if(templateObj === parseInt(templateObj, 10)) {
                templateObj = getTemplateById(templateObjOrId);
            }
            var range = quill.getSelection(true);
            if(idx != null && length != null) {
                range = { index: idx, length: len };
            }

            var tl = getTemplates();
            var isNew = templateObj == null;
            var newTemplateObj = templateObj;
            if(isNew) {
                newTemplateObj = {
                    templateId: getNewTemplateId(),
                    templateColor: getRandomColor(),
                    templateName: quill.getText(range.index, range.length).trim()
                };
            }
            newTemplateObj.docIdx = range.index;
            //if (templateId != null) {
            //    for (var i = 0; i < tl.length; i++) {
            //        var t = tl[i];
            //        if (t['templateId'] == templateId) {
            //            newTemplateObj = t;
            //            break;
            //        }
            //    }
            //}
            if(range.length == 0 && isNew) {
                newTemplateObj['templateName'] = getLowestAnonTemplateName();//"Template #" + parseInt(tl.length + 1);
            }

            quill.deleteText(range.index, range.length,Quill.sources.SILENT);
            if(Math.abs(parseInt(range.length)) > 0) {
                shiftTemplates(range.index, -range.length);
            }
            shiftTemplates(range.index, 1);
            quill.insertEmbed(range.index, "templatespan", newTemplateObj, Quill.sources.SILENT);
            var eofIdx = quill.getLength();
            if (range.index + newTemplateObj['templateName'].length >= eofIdx) {
                quill.insertText(range.index + 1, ' ', Quill.sources.SILENT);
            }
            quill.setSelection(range.index + 1, Quill.sources.API);

            //var tElml = document.getElementsByClassName("template_btn");
            //for (var i = 0; i < tElml.length; i++) {
            //    var tElm = tElml[i];
            //    if (tElm.getAttribute('templateId') == newTemplateObj['templateId']) {
            //        tElm.addEventListener('click', function (e) {
            //            wasLastClickOnTemplate = true;
            //            selectTemplate(tElm.getAttribute('templateId'), false);
            //        });
            //    }
            //}
            selectTemplate(newTemplateObj['templateId']);

            console.log(getTemplates());
            return range.index;
        }

        function getLowestAnonTemplateName(anonPrefix = 'Template #') {
            var tl = getTemplates();
            var maxNum = 0;
            tl.forEach(function (t) {
                if(t.templateName.startsWith(anonPrefix)) {
                    var anonNum = parseInt(t.templateName.substring(anonPrefix.length));
                    maxNum = Math.max(maxNum, anonNum);
                }
            });
            return anonPrefix + (parseInt(maxNum) + 1);
        }

        function getNewTemplateId() {
            var tl = getTemplates();
            var minId = 0;
            tl.forEach(function (t) {
                minId = Math.min(minId, t.templateId);
            });
            return (parseInt(minId) - 1);
        }

        function clearTemplateSelection() {
            var stl = document.getElementsByClassName("template_btn");
            for (var i = 0; i < stl.length; i++) {
                var t = stl[i];
                t.style.border = "";
            }
        }

        function selectTemplate(templateId, fromDropDown) {
            if (templateId == null) {
                return;
            }
            var stl = document.getElementsByClassName("template_btn");
            for (var i = 0; i < stl.length; i++) {
                var t = stl[i];
                if (t.getAttribute('templateid') == templateId) {
                    $('#templateTextArea').placeholder = "Enter text for " + t.innerText;
                    if (t.innerText != getTemplateById(templateId)['templateName']) {
                        $('#templateTextArea').val(t.innerText);
                    } else {
                        $('#templateTextArea').val('');
                    }
                    selectedTemplateId = templateId;
                    t.style.border = "2px solid red"
                } else {
                    t.style.border = "";
                }
            }
            if (fromDropDown == null || !fromDropDown) {
                var items = document.getElementById('custom-select').getElementsByTagName("div");
                for (var i = 0; i < items.length; i++) {
                    if (items[i].getAttribute('optionId') != null && items[i].getAttribute('optionId') == selectedTemplateId) {
                        //onTemplateOptionClick(null, items[i]);
                        eventFire(items[i], 'click');
                        break;
                    }
                }
            }
        }

        function eventFire(el, etype) {
            if (el.fireEvent) {
                el.fireEvent('on' + etype);
            } else {
                var evObj = document.createEvent('Events');
                evObj.initEvent(etype, true, false);
                el.dispatchEvent(evObj);
            }
        }

        function templateTextAreaChange() {
            var curText = $('#templateTextArea').val();
            setTemplateText(selectedTemplateId, curText);
        }

        function setTemplateText(templateId, text) {
            var stl = document.getElementsByClassName("template_btn");
            for (var i = 0; i < stl.length; i++) {
                var t = stl[i];
                if (t.getAttribute('templateid') == templateId) {
                    t.innerText = text;
                }
            }
        }

        function setTemplateDocIdx(t, oldIdx, newIdx) {
            var domTemplates = document.getElementsByClassName("template_btn");
            for(var i = 0; i < domTemplates.length; i++) {
                var domTemplate = domTemplates[i];
                var template = {
                    templateId: domTemplate.getAttribute('templateId'),
                    templateName: domTemplate.getAttribute('templateName'),
                    templateColor: domTemplate.getAttribute('templateColor'),
                    docIdx: domTemplate.getAttribute('docIdx'),
                    templateText: domTemplate.innerText
                }
                if(template.templateId == t.templateId && template.docIdx == oldIdx) {
                    domTemplate.setAttribute('docIdx', newIdx);
                    return;
                }
            }
        }

        function getTemplates() {
            var domTemplates = document.getElementsByClassName("template_btn");
            var templates = [];
            for (var i = 0; i < domTemplates.length; i++) {
                var domTemplate = domTemplates[i];
                var template = {
                    templateId: domTemplate.getAttribute('templateId'),
                    templateName: domTemplate.getAttribute('templateName'),
                    templateColor: domTemplate.getAttribute('templateColor'),
                    docIdx: domTemplate.getAttribute('docIdx'),
                    templateText: domTemplate.innerText
                }
                var curTemplateIdx = -1;
                for (var j = 0; j < templates.length; j++) {
                    if(templates[j]['templateId'] == template['templateId']) {
                        curTemplateIdx = j;
                        break;
                    }
                }
                if(curTemplateIdx >= 0) {
                    if(Array.isArray(templates[curTemplateIdx].docIdx)) {
                        templates[curTemplateIdx].docIdx.push(template.docIdx);
                    } else {
                        templates[curTemplateIdx].docIdx = [templates[curTemplateIdx].docIdx, template.docIdx];
                    }
                } else {
                    templates.push(template);
                }
            }
            return templates;
        }

        function getTemplatesJson() {
            return JSON.stringify(getTemplates());
        }

        function getTemplateById(templateId) {
            var tl = getTemplates();
            for (var i = 0; i < tl.length; i++) {
                var t = tl[i];
                if (t['templateId'] == templateId) {
                    return t;
                }
            }
            return null;
        }

        function showTemplateContextMenu(tb) {
            clickCount = 0;

            var rgtClickContextMenu = document.getElementById('templateToolbarMenu');
            var rgtClickContextMenuList = document.getElementById('templateToolbarMenuList');
            rgtClickContextMenuList.innerHTML = '';

            
            var tl = getTemplates();
            var listItemPrefix = 'templateListItem_';
            for (var i = 0; i < tl.length; i++) {
                var t = tl[i];
                var itemId = listItemPrefix + t.templateId;
                var templateItem = '<li><a href="javascript:void(0);" onclick="createTemplate(' + t['templateId'] + ');">' +
                    '<div style="display:inline-block;margin: 0 5px 0 0;width: 15px; height: 15px;background-color:' + t['templateColor'] + '"></div>' +
                    '<span style="font-family:arial;">' + t['templateName'] + '</span></a></li>';
                rgtClickContextMenuList.innerHTML += templateItem;
            }

            rgtClickContextMenuList.innerHTML += '<li><a href="javascript:void(0);" onclick="createTemplate();">' +
                '<span style="margin: 0 5px 0 0;color:lightseagreen;font-size:20px">+</span>' +
                '<span style="font-family:arial;">Add Template</span></a></li>';
            const rect = tb.getBoundingClientRect();
            const x = rect.left + 20;
            const y = rect.bottom;
            rgtClickContextMenu.style.left = `${x}px`;
            rgtClickContextMenu.style.top = `${y}px`;
            rgtClickContextMenu.style.display = 'block';

            isShowingTemplateMenu = true;
        }

        function hideTemplateContextMenu() {
            var rgtClickContextMenu = document.getElementById('templateToolbarMenu');
            rgtClickContextMenu.style.display = 'none';

            isShowingTemplateMenu = false;
        }

        function showPasteTemplateToolbar() {
            isShowingPasteTemplateToolbar = true;
            var ptt = document.getElementById('pasteTemplateToolbar');
            ptt.style.display = 'inline-block';

            document.getElementById('custom-select').innerHTML = '<select id="pasteTemplateToolbarMenuSelector"></select >';

            var templateMenuSelector = document.getElementById('pasteTemplateToolbarMenuSelector');
            templateMenuSelector.innerHTML = '';

            var tl = getTemplates();
            for (var i = 0; i < tl.length; i++) {
                var t = tl[i];
                var templateItem = '<option class="templateOption" value="' + t['templateId'] + '" onchange="selectTemplate(' + t['templateId'] + ');">' +
                    t['templateName'] + '</option>';
                templateMenuSelector.innerHTML += templateItem;
            }


            document.getElementById('nextTemplateButton').addEventListener('click', function (e) {
                gotoNextTemplate();
            });
            document.getElementById('nextTemplateButton').addEventListener('keydown', function (e) {
                gotoNextTemplate();
            });
            document.getElementById('previousTemplateButton').addEventListener('click', function (e) {
                gotoPrevTemplate();
            });
            document.getElementById('previousTemplateButton').addEventListener('keydown', function (e) {
                gotoPrevTemplate();
            });
            document.getElementById('clearAllTemplateTextButton').addEventListener('click', function (e) {
                clearAllTemplateText();
            });
            document.getElementById('clearAllTemplateTextButton').addEventListener('keydown', function (e) {
                clearAllTemplateText();
            });
            document.getElementById('pasteTemplateButton').addEventListener('click', function (e) {
                isCompleted = true;
            });
            document.getElementById('pasteTemplateButton').addEventListener('keydown', function (e) {
                isCompleted = true;
            });

            createTemplateSelectorStyling(templateMenuSelector);


            let tbb = isShowingToolbar ? $(".ql-toolbar").outerHeight() : 0;
            moveToolbarTop(0);
            moveTemplateToolbarTop(tbb);
            moveEditorTop($("#pasteTemplateToolbar").outerHeight() + tbb);

            $('#templateTextArea').focus();
        }


        function hidePasteTemplateToolbar() {
            isShowingPasteTemplateToolbar = false;
            var ptt = document.getElementById('pasteTemplateToolbar');
            ptt.style.display = 'none';
            if(isShowingToolbar) {
                moveEditorTop($(".ql-toolbar").outerHeight());
            } else {
                moveEditorTop(0);                
            }
        }

        function gotoNextTemplate() {
            var curIdx = 0;
            for (var i = 0; i < tl.length; i++) {
                if (tl[i]['templateId'] == selectedTemplateId) {
                    curIdx = i;
                    break;
                }
            }
            var nextIdx = curIdx + 1;
            if (nextIdx >= tl.length) {
                nextIdx = 0;
            }
            selectTemplate(tl[nextIdx]['templateId']);
        }

        function gotoPrevTemplate() {
            var curIdx = 0;
            for (var i = 0; i < tl.length; i++) {
                if (tl[i]['templateId'] == selectedTemplateId) {
                    curIdx = i;
                    break;
                }
            }
            var prevIdx = curIdx - 1;
            if (prevIdx < 0) {
                prevIdx = tl.length - 1;
            }
            selectTemplate(tl[prevIdx]['templateId']);
        }

        function clearAllTemplateText() {
            var tl = getTemplates();
            for (var i = 0; i < tl.length; i++) {
                setTemplateText(tl[i]['templateId'], '');
            }
        }

        function createTemplateSelectorStyling() {
            var tl = getTemplates();
            var x, i, j, selElmnt, a, b, c;
            x = document.getElementsByClassName("custom-select");
            for (i = 0; i < x.length; i++) {
                selElmnt = x[i].getElementsByTagName("select")[0];
                if(selElmnt.options.length == 0) {
                    continue;
                }
                var st = getTemplateById(selElmnt.options[selElmnt.selectedIndex].getAttribute('value'));
                a = document.createElement("DIV");
                a.setAttribute("class", "select-selected");
                a2 = document.createElement("SPAN");
                a2.setAttribute("class", "square-box");
                a2.setAttribute("style", "background-color: " + st['templateColor']);
                a.appendChild(a2);
                a.innerHTML += '<span style="margin: 0 10px 0 50px;">' + selElmnt.options[selElmnt.selectedIndex].innerHTML + '</span>';
                x[i].appendChild(a);
                b = document.createElement("DIV");
                b.setAttribute("class", "select-items select-hide");
                for (j = 0; j < selElmnt.length; j++) {
                    var t = getTemplateById(selElmnt.options[j].getAttribute('value'));
                    c = document.createElement("DIV");
                    c.setAttribute('optionId', parseInt(t['templateId']));
                    //c.innerHTML = selElmnt.options[j].innerHTML;
                    d = document.createElement("SPAN");
                    d.setAttribute("class", "square-box");
                    d.setAttribute("style", "background-color: " + t['templateColor']);
                    c.appendChild(d);
                    c.innerHTML += selElmnt.options[j].innerHTML;
                    c.addEventListener("click", onTemplateOptionClick);
                    b.appendChild(c);
                    if (j == selElmnt.selectedIndex) {
                        c.classList.add("class", "same-as-selected");
                    }
                }
                x[i].appendChild(b);
                a.addEventListener("click", function (e) {
                    e.stopPropagation();
                    closeAllSelect(this);
                    this.nextSibling.classList.toggle("select-hide");
                    this.classList.toggle("select-arrow-active");
                });

            }

            function closeAllSelect(elmnt) {
                var x, y, i, arrNo = [];
                x = document.getElementsByClassName("select-items");
                y = document.getElementsByClassName("select-selected");
                for (i = 0; i < y.length; i++) {
                    if (elmnt == y[i]) {
                        arrNo.push(i)
                    } else {
                        y[i].classList.remove("select-arrow-active");
                    }
                }
                for (i = 0; i < x.length; i++) {
                    if (arrNo.indexOf(i)) {
                        x[i].classList.add("select-hide");
                    }
                }
            }
            document.addEventListener("click", closeAllSelect);
        }

        function onTemplateOptionClick(e, target) {
            var targetDiv = e == null ? target : e.currentTarget;
            var tVal = parseInt(targetDiv.getAttribute('optionId'));
            var t = getTemplateById(tVal);
            var y, i, k, s, h;
            s = targetDiv.parentNode.parentNode.getElementsByTagName("select")[0];
            h = targetDiv.parentNode.previousSibling;
            for (i = 0; i < s.length; i++) {
                var sVal = parseInt(s.options[i].value);
                if (sVal == tVal) {
                    s.selectedIndex = i;
                    h.innerHTML = targetDiv.innerHTML.replace(t['templateName'], '<span style="margin: 0 10px 0 50px;">' + t['templateName'] + '</span>');
                    y = targetDiv.parentNode.getElementsByClassName("same-as-selected");
                    for (k = 0; k < y.length; k++) {
                        y[k].removeAttribute("class");
                    }
                    targetDiv.setAttribute("class", "same-as-selected");
                    break;
                }
            }

            selectTemplate(s.options[s.selectedIndex].value, true);
            h.click();
        }


        function getFontName(font) {
            // Generate code-friendly font names
            return font.toLowerCase().replace(/\s/g, "-");
        }

        function setText(text) {
            quill.setText(text + '\n');
        }

        function setHtml(html) {
            //var delta = quill.clipboard.convert(html);
            //quill.setContents(delta, 'silent');
            quill.root.innerHTML = html;
        }

        function getContentsAsJson() {
            return JSON.stringify(quill.getContents());
        }

        function setContents(jsonStr) {
            quill.setContents(JSON.parse(jsonStr));
        }

        function getText() {
            var text = quill.getText(0, quill.getLength() - 1);
            return text;
        }
        
        function isEditorLoaded() {
            return isLoaded;
        }

        function hideToolbar() {
            isShowingToolbar = false;
            $(".ql-toolbar").css("display", "none");
            if(isShowingPasteTemplateToolbar) {
                moveTemplateToolbarTop(0);
                let pttbh = $("#pasteTemplateToolbar").outerHeight();
                moveEditorTop(pttbh);
            } else {
                moveEditorTop(0);
            }
        }

        function showToolbar() {
            isShowingToolbar = true;
            $(".ql-toolbar").css("display", "inline-block");
            let tbh = $(".ql-toolbar").outerHeight();
            if(isShowingPasteTemplateToolbar) {
                moveTemplateToolbarTop(tbh);
                let pttbh = $("#pasteTemplateToolbar").outerHeight();
                moveEditorTop(tbh + pttbh);
            } else {
                moveEditorTop(tbh);
            }
        }

        function getEditorHeight() {
            return parseInt($('.ql-editor').outerHeight());
        }

        function getToolbarHeight() {
            return parseInt($('.ql-toolbar').outerHeight());
        }

        function isReadOnly() {
            return $('.ql-editor').attr('contenteditable');
        }

        function enableReadOnly() {
            $('.ql-editor').attr('contenteditable', false);
            $('.ql-editor').css('caret-color', 'transparent');
        }

        function disableReadOnly() {
            $('.ql-editor').attr('contenteditable', true);
            $('.ql-editor').css('caret-color', 'black');
        }

        function getTextWithEmbedTokens() {
            var text = getText().split('');
            var otl = getTemplatesByDocOrder()
            var outText = '';
            var offset = 0;
            otl.forEach(function (ot) {
                offset += parseInt(ot.docIdx);
                var embedStr = getTemplateEmbedStr(ot);
                //text.splice(offset, 1);
                for(var i = 0; i < embedStr.length; i++) {
                    text.splice(offset + i, 0, embedStr[i]);
                }
                offset += (embedStr.length);
            });
            return text.join('');
        }

        function getTemplatesByDocOrder() {
            var til = getTemplateInstances();
            til.sort((a, b) => (parseInt(a.docIdx) > parseInt(b.docIdx)) ? 1 : -1);
            return til;
        }

        function getTemplateInstances() {
            var til = [];
            getTemplates().forEach(function (t) {
                if(Array.isArray(t.docIdx)) {
                    t.docIdx.forEach(function (tDocIdx) {
                        var ti = new Object();
                        var ti = Object.assign(ti, t);
                        ti.docIdx = tDocIdx;
                        til.push(ti);
                    });
                } else {
                    til.push(t);
                }
            });
            return til;
        }

        function getTemplateOffset(_t, idx) {
            var _tDocIdx = Array.isArray(_t.docIdx) ? _t.docIdx[idx] : _t.docIdx;
            var text = getText();
            var tl = getTemplates();
            var offset = 0;
            tl.forEach(function (t) {
                var embedStr = '{{' + t.templateId + '}}';
                if(Array.isArray(t.docIdx)) {
                    t.docIdx.forEach(function (tDocIdx) {
                        if(tDocIdx < _tDocIdx) {
                            offset += getTemplateEmbedStr(t).length;
                        }
                    });
                } else {
                    if(t.docIdx < _tDocIdx) {
                        offset += getTemplateEmbedStr(t).length;
                    }
                }
            });
            return offset;
        }

        function getTemplateEmbedStr(t) {
            return '{{' + t.templateId + '}}';
        }

        function getHtml() {
            //document.getElementsByClassName
            //var val = document.getElementsByClassName("ql-editor")[0].innerHTML;
            clearTemplateSelection();
            var val = quill.root.innerHTML;
            return unescape(val);
        }

        function getTemplatesJson() {
            var val = JSON.stringify(getTemplates());
            return val;
        }

        function decodeHtml(html) {
            var txt = document.createElement("textarea");
            txt.innerHTML = html;
            return txt.value;
        }

        function getRandomColor() {
            var letters = '0123456789ABCDEF';
            var color = '#';
            for (var i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }

        function isBright(hex, brightThreshold = 150) {
            var c = hexToRgb(hex.toLowerCase());
            var grayVal = Math.sqrt(
                c.R * c.R * .299 +
                c.G * c.G * .587 +
                c.B * c.B  * .114);
            return grayVal > brightThreshold;
        }
        function hexToRgb(hex) {
            var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                R: parseInt(result[1], 16),
                G: parseInt(result[2], 16),
                B: parseInt(result[3], 16)
            } : null;
        }

        function createLink() {
            var range = quill.getSelection(true);
            if (range) {
                var text = quill.getText(range.index, range.length);
                quill.deleteText(range.index, range.length);
                var ts = '<a class="square_btn" href="https://www.google.com">' + text + '</a>';
                quill.clipboard.dangerouslyPasteHTML(range.index, ts);

                console.log('text:\n' + getText());
                console.table('\nhtml:\n' + getHtml());
            }
        }

        function moveToolbarTop(y) {
            $(".ql-toolbar").css("position", "absolute");
            $(".ql-toolbar").css("top", y);

            //var viewportBottom = window.scrollY + window.innerHeight;
            //let tbh = $(".ql-toolbar").outerHeight();
            //if (y <= 0) {
            //    //keyboard is not visible
            //    $(".ql-toolbar").css("top", y);
            //    $("#editor").css("top", y + tbh);
            //} else {
            //    $(".ql-toolbar").css("top", y - tbh);
            //    $("#editor").css("top", 0);
            //}
            //$("#editor").css("bottom", viewportBottom - tbh);
        }

        function moveTemplateToolbarTop(y) {
            $("#pasteTemplateToolbar").css("position", "absolute");
            $("#pasteTemplateToolbar").css("top", y);
        }

        function moveEditorTop(y) {
            $("#editor").css("position", "absolute");
            $("#editor").css("top", y);
        }
        function getTemplateIconStr(isEnabled) {
            if(isEnabled) {
                return "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAOEAAADhCAMAAAAJbSJIAAAAaVBMVEX/////wQf/vwD/24f/3Iz///3/vQD/ykL/yTj/yT3/0WH/0F7/0Fv/y0T/y0f/yTr/35T/wxT/8tP/6Lj/5az/7sj/9uX/46P/1G7/677/57P/2oL/xSj/8M//1nj//fb//O//4Zz/zVBsBjAmAAAEzklEQVR4nO2di3qiMBBGIUpa1168tFZ70933f8hl0KqVWCuZyfzhm/MAfJ7vhAmwCy0KwzAMwzAMwzAMwzAMwzAMWKq3QSzDyXymrXGe6ta7eLwvl8/aKmGqW1fy4Pz0SdsmAJ9g4zhaaAudwirYOIJl5Bas8QNtqWMEBLEURQRrRZiFKiRYK4KMGzHB0j1ouzXICdYR59p2haxg6d619YQF64gfPRcs3ae24KOsYOmmyoLCBUvtDSOBYOk176TEl2hjqHhdw1WwvuetOXcsN9ET5Cno/PJ1tvh4Gp9xdEM1QZ6C/m29O+Dmj4cyZCroV0fHfAkpahlyFfw+KEOKSoZcBU9//bh9WB1Dtn3w9MCbdkQVQ7Ztov3j71pH1jBk2+h9++n2UyuigiHfpZrftA7+AWDIeKnm162jL/QNOS+2Aw1n6oasF9uB83Cubch7uxS4qF4qz9JqxHq71L5/Xyvvh+z3g/40YjthUkOBG96TM7F9FiY1ZF6i25/vjhVXuvcWUv/4sl+o60/d+0OJglvF6XC2WS+eP53uPb7gUzV34TlNGkOxgpdJY5jiuaiqoWLBNIZJHvxqGuoKJjBUXaIpDDWHTBJD7YLihuoFxQ3VCwob6i9RacMbAEFJwwpCUNIQQ1DOEKSgoCHCkGkQMoQpKGUIsU3skDHEKShjiFRQxhCpoIQh0JBp4DcEE2Q3RCvIbwg1ZBp4DfEKMhtibRM7WA3vAQU5DRGXaMlqCFmQ0RC0IKMhqiCXYQW6REs2Q9iCXIa4BZkMgQvyGCIX5DCE3SZ2xBtiF4w3RC8YbwgvGGkIvNHviTPELxhpmEHBOMMcCkYZPmQh2H77q2cFS/dQ9bugu+laMIshE/Ntk1wEOxccB//POBzdC75lInjfVfC574LFNIuTMOIDSn+zSNh9yBRV3wsWrzkkjCgYeh8cj6iPmOWwSKMKBl4lhsPdd73YbsA/DeMKFsUEfZW6m6iCRTEAN4y4ksnDMLog+iqNLxh+XRqG2CHTgLxbcBSE3vFZChbBTzFhELnRH0A9EbkK1mirhGHYJvYEv/umDc+Q+eId70zkLFggbhi8BWsmYIqMQ+aLJZQie0EC6aG3GwkIFkX4W6EaMA8ZPEWBc/ALjIUqVpBAqChYkLhTV3QjwYKEdkXhgoRuRfGChGZF0SFzQG+iCm30bbQqJiqop5hgyBzQWKgJCxLpKyYtSKTeNJJsE99JWzF5QSJlRYWCRLqKiYfMgVQT1d0qCaaqqLRE0ym6R0XBFAtVWVC+ouoS3SK7aSgOmQOSFQEKEnIVIQoSUhVBChIyExWmICFREaggwa+ovg+ewr1Q4QS5K4It0S2cmwbUkDnAVxGyIMFVEbQgwVMRcMgc4JiowAWJ+IrQBYlYRfCCRNxCzUAwriL8Et3SfdPIoiDRtWImBYluFbMpSHSpmFFB4vqJmlVB4tqKmRUkrlPMriBxzULNUvCaihku0S2/3TQyLUj8rmK2BYnfVMy4IHG5YuaClydq9oKXKvZA8GfFXgj+tFB7Inj+hSLf+btqcEyCf7nXL7V/FyOz91ZGX660fxUvL+VxR+fdpDcrdM9q7Lx3jv7gtPv32j8/oprNJ8PB5HXWTz3DMAzDMAzDMAzDMAzDMHrEf9VjaGNa1FYRAAAAAElFTkSuQmCC";
            } else {
                return 'data:image/png;base64,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';
            }
        }
                    //==================================================================================================
        init(null, null, null, null, null);
    </script>

</body>
</html>

