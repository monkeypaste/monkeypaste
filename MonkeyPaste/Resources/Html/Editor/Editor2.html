<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title>Yo this is a title</title>
    <link href="https://cdn.quilljs.com/2.0.0-dev.4/quill.snow.css"
          rel="stylesheet" />
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.2/styles/github.min.css" />
    <link type="text/css" href="https://unpkg.com/quill-better-table@1.2.7/dist/quill-better-table.css" rel="stylesheet" />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.2/highlight.min.js"></script>
    <script charset="UTF-8"
            src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.2/languages/xml.min.js"></script>
    <script src="https://cdn.quilljs.com/2.0.0-dev.4/quill.min.js"></script>


    <script src="https://cdn.quilljs.com/2.0.0-dev.3/quill.js"></script>
    <script src="https://unpkg.com/quill-better-table@1.2.8/dist/quill-better-table.min.js"></script>
    <link type="text/css" href="https://cdn.quilljs.com/2.0.0-dev.3/quill.snow.css" rel="stylesheet">
    <link type="text/css" href="https://unpkg.com/quill-better-table@1.2.7/dist/quill-better-table.css" rel="stylesheet" />

    <script src="https://unpkg.com/quill-better-table@1.2.8/dist/quill-better-table.min.js"></script>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>

    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script src="https://cdn.jsdelivr.net/gh/T-vK/DynamicQuillTools@master/DynamicQuillTools.js"></script>

    <style>
        body {
            margin: 0px;
            padding: 0px;
            font-family: Arial;
        }

        .btn {
            border: none;
            background-color: green;
            padding: 14px 28px;
            font-size: 16px;
            cursor: pointer;
            display: inline-block;
        }

            /* On mouse-over */
            .btn:hover {
                background: #eee;
            }

        .success {
            color: green;
        }

        #editor {
            width: 100%;
        }

        .ql-toolbar {
            width: 100%;
        }

        .ql-templatebutton:after {
            /*/content: "§";*/
            height: 15px;
            width: 15px;
            background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAOEAAADhCAMAAAAJbSJIAAAAaVBMVEX/////wQf/vwD/24f/3Iz///3/vQD/ykL/yTj/yT3/0WH/0F7/0Fv/y0T/y0f/yTr/35T/wxT/8tP/6Lj/5az/7sj/9uX/46P/1G7/677/57P/2oL/xSj/8M//1nj//fb//O//4Zz/zVBsBjAmAAAEzklEQVR4nO2di3qiMBBGIUpa1168tFZ70933f8hl0KqVWCuZyfzhm/MAfJ7vhAmwCy0KwzAMwzAMwzAMwzAMwzAMWKq3QSzDyXymrXGe6ta7eLwvl8/aKmGqW1fy4Pz0SdsmAJ9g4zhaaAudwirYOIJl5Bas8QNtqWMEBLEURQRrRZiFKiRYK4KMGzHB0j1ouzXICdYR59p2haxg6d619YQF64gfPRcs3ae24KOsYOmmyoLCBUvtDSOBYOk176TEl2hjqHhdw1WwvuetOXcsN9ET5Cno/PJ1tvh4Gp9xdEM1QZ6C/m29O+Dmj4cyZCroV0fHfAkpahlyFfw+KEOKSoZcBU9//bh9WB1Dtn3w9MCbdkQVQ7Ztov3j71pH1jBk2+h9++n2UyuigiHfpZrftA7+AWDIeKnm162jL/QNOS+2Aw1n6oasF9uB83Cubch7uxS4qF4qz9JqxHq71L5/Xyvvh+z3g/40YjthUkOBG96TM7F9FiY1ZF6i25/vjhVXuvcWUv/4sl+o60/d+0OJglvF6XC2WS+eP53uPb7gUzV34TlNGkOxgpdJY5jiuaiqoWLBNIZJHvxqGuoKJjBUXaIpDDWHTBJD7YLihuoFxQ3VCwob6i9RacMbAEFJwwpCUNIQQ1DOEKSgoCHCkGkQMoQpKGUIsU3skDHEKShjiFRQxhCpoIQh0JBp4DcEE2Q3RCvIbwg1ZBp4DfEKMhtibRM7WA3vAQU5DRGXaMlqCFmQ0RC0IKMhqiCXYQW6REs2Q9iCXIa4BZkMgQvyGCIX5DCE3SZ2xBtiF4w3RC8YbwgvGGkIvNHviTPELxhpmEHBOMMcCkYZPmQh2H77q2cFS/dQ9bugu+laMIshE/Ntk1wEOxccB//POBzdC75lInjfVfC574LFNIuTMOIDSn+zSNh9yBRV3wsWrzkkjCgYeh8cj6iPmOWwSKMKBl4lhsPdd73YbsA/DeMKFsUEfZW6m6iCRTEAN4y4ksnDMLog+iqNLxh+XRqG2CHTgLxbcBSE3vFZChbBTzFhELnRH0A9EbkK1mirhGHYJvYEv/umDc+Q+eId70zkLFggbhi8BWsmYIqMQ+aLJZQie0EC6aG3GwkIFkX4W6EaMA8ZPEWBc/ALjIUqVpBAqChYkLhTV3QjwYKEdkXhgoRuRfGChGZF0SFzQG+iCm30bbQqJiqop5hgyBzQWKgJCxLpKyYtSKTeNJJsE99JWzF5QSJlRYWCRLqKiYfMgVQT1d0qCaaqqLRE0ym6R0XBFAtVWVC+ouoS3SK7aSgOmQOSFQEKEnIVIQoSUhVBChIyExWmICFREaggwa+ovg+ewr1Q4QS5K4It0S2cmwbUkDnAVxGyIMFVEbQgwVMRcMgc4JiowAWJ+IrQBYlYRfCCRNxCzUAwriL8Et3SfdPIoiDRtWImBYluFbMpSHSpmFFB4vqJmlVB4tqKmRUkrlPMriBxzULNUvCaihku0S2/3TQyLUj8rmK2BYnfVMy4IHG5YuaClydq9oKXKvZA8GfFXgj+tFB7Inj+hSLf+btqcEyCf7nXL7V/FyOz91ZGX660fxUvL+VxR+fdpDcrdM9q7Lx3jv7gtPv32j8/oprNJ8PB5HXWTz3DMAzDMAzDMAzDMAzDMHrEf9VjaGNa1FYRAAAAAElFTkSuQmCC");
        }

        span.template {
            border-style: solid;
            border-color: white;
            border-radius: 10px;
            padding: 7px;
            background-color: purple;
            color: white;
            text-align: center;
            font-size: medium;
        }

        /* maps font sizes to font drop down*/
        .ql-snow
        .ql-picker.ql-size
        .ql-picker-label[data-value]::before,
        .ql-snow .ql-picker.ql-size
        .ql-picker-item[data-value]::before {
            content: attr(data-value) !important;
        }

        /* Table Styles*/
        .ql-snow .ql-Table-Input .ql-picker-options {
            padding: 3px 5px;
            width: 152px;
        }

        .ql-snow .ql-Table-Input .ql-picker-item {
            border: 1px solid transparent;
            float: left;
            height: 16px;
            margin: 2px;
            padding: 0px;
            width: 16px;
            background: lightsteelblue;
        }

            .ql-snow .ql-Table-Input .ql-picker-item:hover, .ql-snow .ql-Table-Input .ql-picker-item.ql-picker-item-highlight {
                border-color: #000;
                background: steelblue;
            }

        .ql-snow .ql-Table-Input.ql-picker {
            width: 28px;
        }

            .ql-snow .ql-Table-Input.ql-picker .ql-picker-label {
                padding: 2px 4px;
            }

        /* Template Button */
        .template_btn {
            display: inline;
            padding: 1px;
            text-decoration: none;
                color: #67c5ff;
            border-radius: 3px;
            transition: .4s;
            margin: 0 1px;
        }

            .template_btn:hover {
                padding: 3px;
                transition: .2s;
                cursor: pointer;
            }


        .selectedTemplate {
        }

        /* Template Context Menu*/
        .cls-context-menu-link {
            display: block;
            padding: 20px;
            background: #ECECEC;
        }

        .cls-context-menu {
            position: absolute;
            display: none;
        }

            .cls-context-menu ul,
            #context-menu li {
                list-style: none;
                margin: 0;
                padding: 0;
                background: white;
            }

        .cls-context-menu {
            border: solid 1px #CCC;
        }

            .cls-context-menu li {
                border-bottom: solid 1px #CCC;
            }

                .cls-context-menu li:last-child {
                    border: none;
                }

                .cls-context-menu li a {
                    display: block;
                    padding: 5px 10px;
                    text-decoration: none;
                    color: blue;
                }

                    .cls-context-menu li a:hover {
                        background: blue;
                        color: #FFF;
                    }

        /* Paste Template Toolbar */
        .paste-template-toolbar {
            display: none;
            position: absolute;
            width: 100%;
            height: 45px;
            background-color: lightyellow;
            border: solid 2px dimgray;
            padding: 5px 10px;
        }

        .paste-template-toolbar-btn {
            display: inline-block;
            padding: 5px;
            text-decoration: none;
            border: 1px solid #CCC;
            color: white;
            border: solid 2px #67c5ff;
            border-radius: 7px;
            transition: .4s;
            margin: 0 5px;
            background-color: dodgerblue;
            cursor: pointer;
        }

        paste-template-toolbar-btn:hover {
            background-color: lightblue;
            transition: .4s; 
            padding: 10px;
            color: white;
            cursor: pointer;
        }

        /* Custom Selector style*/
        .Select-menu-outer {
            top: auto;
            bottom: 100%
        }

        .custom-select {
            display: inline-block;
            position: relative;
            font-family: Arial;
        }

            .custom-select select {
                display: none;
            }

        .select-selected {
            background-color: DodgerBlue;
        }

        .select-selected-item {
            background-color: lightblue;
        }

        .select-selected:before {
            position: absolute;
            content: "";
            top: 7px;
            left: 5px;
            width: 0;
            height: 0;
            border: 6px solid transparent;
            border-color: #fff transparent transparent transparent;
        }

        .select-selected.select-arrow-active:before {
            border-color: transparent transparent #fff transparent;
            top: 10px;
        }

        .select-items div,
        .select-selected {
            color: #ffffff;
            padding: 12px 5px;
            border: 1px solid transparent;
            border-color: transparent transparent rgba(0, 0, 0, 0.1) transparent;
            cursor: pointer;
            user-select: none;
        }

        .select-items {
            position: absolute;
            background-color: DodgerBlue;
            top: 100%;
            left: 0;
            right: 0;
            z-index: 99;
        }

        .select-hide {
            display: none;
        }

        .select-items div:hover,
        .same-as-selected {
            background-color: rgba(0, 0, 0, 0.1);
        }

        .select-items .square-box {
            height: 18px;
            width: 18px;
            float: left;
            margin: 0 20px 0 20px;
        }

        .select-selected .square-box {
            height: 18px;
            width: 18px;
            position: absolute;
            margin: 0 20px 0 20px;
        }
    </style>
</head>
<body>

    <div id='editor'>
    </div>

    <div id="templateToolbarMenu" class="cls-context-menu">
        <ul id="templateToolbarMenuList">
        </ul>
    </div>
    <div id="pasteTemplateToolbar" class="paste-template-toolbar">
        <div id="custom-select" class="custom-select" style="min-width:160px;">
            <select id="pasteTemplateToolbarMenuSelector">
            </select>
        </div>
        <div id="clearAllTemplateTextButton" tabindex="0" class="paste-template-toolbar-btn">
            <span>CLEAR ALL</span>
        </div>
        <div style="display:inline-block">
            <input id="templateTextArea" tabindex="1" onchange="templateTextAreaChange()" onkeyup="templateTextAreaChange()" onsearch="templateTextAreaChange()" type="search" cols="30" />
        </div>
        <div id="previousTemplateButton" tabindex="2" class="paste-template-toolbar-btn">
            <span>◄</span>
        </div>
        <div id="nextTemplateButton" tabindex="3" class="paste-template-toolbar-btn">
            <span>►</span>
        </div>
        <div id="pasteTemplateButton" tabindex="4" class="paste-template-toolbar-btn">
            <span>FINISH</span>
        </div>
    </div>

    <script src="https://cdn.polyfill.io/v2/polyfill.min.js?features=Promise"
            crossorigin="anonymous"></script>
    <script src="https://benwinding.github.io/quill-html-edit-button/dist/quill.htmlEditButton.min.js"></script>
    <script type="text/javascript">
        var curQuillDiv = $("#editor");
        var quill;
        var isShowingTemplateMenu = false;
        var clickCount = 0;
        var selectedTemplateId = 0;
        var wasLastClickOnTemplate = false;
        var isCompleted = false;
        var isLoaded = false;
        var isPastingTemplate = false;
        var isShowingPasteTemplateToolbar = false;

        function init(html, fontFamilys, fontSizes, defaultFontIdx, indentSize, isFillingTemplates) {
            if (fontFamilys == null) {
                fontFamilys = ['Arial', 'Courier', 'Garamond', 'Tahoma', 'Times New Roman', 'Verdana'];
            }
            if (fontSizes == null) {
                fontSizes = ['8px', '9px', '10px', '12px', '14px', '16px', '20px', '24px', '32px', '42px', '54px', '68px', '84px', '98px'];
            }
            if (defaultFontIdx == null) {
                defaultFontIdx = 0;
            }
            loadQuill(fontFamilys, fontSizes, defaultFontIdx);

            isPastingTemplate = isFillingTemplates;
            isLoaded = true;
            //moveToolbarTop(0);
            if (html != null) {
                setHtml(html);
                var tsIdx = html.indexOf("{{");
                while (tsIdx >= 0) {
                    var curHtml = html.substring(tsIdx);
                    var teIdx = curHtml.indexOf("}}");
                    if (teIdx >= 0) {
                        var tId = curHtml.substring(0, teIdx);
                        
                    }
                }
            }

            

            if (isFillingTemplates) {
                showPasteTemplateToolbar();
            }
        }

        function loadTable() {
            var tableOptions = [];
            var maxRows = 7;
            var maxCols = 7;

            for (let r = 1; r <= maxRows; r++) {
                for (let c = 1; c <= maxCols; c++) {
                    tableOptions.push('newtable_' + r + '_' + c);
                }
            }
            return tableOptions;
        }

        function loadToolbar(fontFamilys, fontSizes, defaultFontIdx) {
            var fonts = loadFonts(fontFamilys);

            var toolbarOptions = [
                //[{ 'size': ['small', false, 'large', 'huge'] }],  // custom dropdown
                [{ 'size': fontSizes }],               // font sizes
                [{ 'font': fonts.whitelist }],
                ['bold', 'italic', 'underline'/*, 'strike'*/],        // toggled buttons
                //['blockquote', 'code-block'],

                // [{ 'header': 1 }, { 'header': 2 }],               // custom button values
                [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                // [{ 'script': 'sub' }, { 'script': 'super' }],      // superscript/subscript
                [{ 'indent': '-1' }, { 'indent': '+1' }],          // outdent/indent
                //[{ 'direction': 'rtl' }],                         // text direction

                // [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
                ['link', 'image', 'video', 'formula'],
                [{ 'color': [] }, { 'background': [] }],          // dropdown with defaults from theme
                [{ 'align': [] }],
                // ['clean'],                                         // remove formatting button
                // ['templatebutton'],
                [{ 'Table-Input': loadTable() }]
            ];

            return toolbarOptions;
        }

        function loadFonts(fontFamilys, fontSizes, defaultFontIdx) {
            // Specify Quill fonts
            var fontNames = fontFamilys.map(font => getFontName(font));
            var fonts = Quill.import('attributors/class/font');
            fonts.whitelist = fontNames;
            Quill.register(fonts, true);

            //font sizes
            var size = Quill.import('attributors/style/size');
            size.whitelist = fontSizes;
            Quill.register(size, true);

            return fonts;
        }

        function loadFontStyles(fontFamilys) {
            // Add fonts to CSS style
            var fontStyles = "";
            fontFamilys.forEach(function (font) {
                var fontName = getFontName(font);
                fontStyles += ".ql-snow .ql-picker.ql-font .ql-picker-label[data-value=" + fontName + "]::before, .ql-snow .ql-picker.ql-font .ql-picker-item[data-value=" + fontName + "]::before {" +
                    "content: '" + font + "';" +
                    "font-family: '" + font + "', sans-serif;" +
                    "}" +
                    ".ql-font-" + fontName + "{" +
                    " font-family: '" + font + "', sans-serif;" +
                    "}";
            });

            return fontStyles;
        }

        function loadTemplateSpan() {
            const Parchment = Quill.imports.parchment;
            const Delta = Quill.imports.delta;

            class TemplateSpan extends Parchment.EmbedBlot {
                static create(value) {
                    const node = super.create(value);
                    var textColor = isBright(value.templateColor) ? 'black' : 'white';
                    node.contentEditable = 'false';
                    node.innerText = value.templateName;
                    node.setAttribute('templateName', value.templateName);
                    node.setAttribute('templateColor', value.templateColor);
                    node.setAttribute('templateId', value.templateId);
                    node.setAttribute('class', 'template_btn');
                    node.setAttribute('style', 'background-color: ' + value.templateColor + ';color:' + textColor + ';');
                    //this._addRemovalButton(node);
                    return node;
                }

                //static value(node) {
                //    return node.childNodes[0].textContent;
                //}
                static value(domNode) {
                    return {
                        templateId: domNode.getAttribute('templateId'),
                        templateName: domNode.getAttribute('templateName'),
                        templateColor: domNode.getAttribute('templateColor'),
                    }
                }

                static _addRemovalButton(node) {
                    const button = document.createElement('button');
                    button.innerText = 'x';
                    button.onclick = () => node.remove();
                    button.contentEditable = 'false';
                    node.appendChild(button);

                    // Extra span forces the cursor to the end of the label, otherwise it appears inside the removal button
                    const span = document.createElement('span');
                    span.innerText = ' ';
                    node.appendChild(span);
                }
            }
            TemplateSpan.blotName = 'templatespan';
            TemplateSpan.tagName = 'SPAN';
            TemplateSpan.className = 'ql-templatespan';

            Quill.register(TemplateSpan);
        }

        function loadQuill(fontFamilys, fontSizes, defaultFontIdx, indentSize) {
            if (isLoaded) {
                return;
            }
            Quill.register("modules/htmlEditButton", htmlEditButton);
            Quill.register({ 'modules/better-table': quillBetterTable }, true);

            loadTemplateSpan();

            // Append the CSS stylesheet to the page
            var node = document.createElement('style');
            node.innerHTML = loadFontStyles(fontFamilys);
            document.body.appendChild(node);

            quill = new Quill(curQuillDiv[0], {
                placeholder: '',
                theme: 'snow',
                modules: {
                    toolbar: loadToolbar(fontFamilys, fontSizes, defaultFontIdx),
                    htmlEditButton: {
                        syntax: true,
                    },
                    table: false,
                    'better-table': {
                        operationMenu: {
                            items: {
                                unmergeCells: {
                                    text: 'Unmerge cells'
                                }
                            },
                            color: {
                                colors: ['green', 'red', 'yellow', 'blue', 'white'],
                                text: 'Background Colors:'
                            }
                        }
                    },
                    keyboard: {
                        bindings: quillBetterTable.keyboardBindings
                    }
                }
            });

            var curTableIconSpan = curQuillDiv.parent().find('span.ql-Table-Input.ql-picker')[0].childNodes[0];
            curTableIconSpan.innerHTML = "<svg style=\"right: 4px;\" viewbox=\"0 0 18 18\"> <rect class=ql-stroke height=12 width=12 x=3 y=3></rect> <rect class=ql-fill height=2 width=3 x=5 y=5></rect> <rect class=ql-fill height=2 width=4 x=9 y=5></rect> <g class=\"ql-fill ql-transparent\"> <rect height=2 width=3 x=5 y=8></rect> <rect height=2 width=4 x=9 y=8></rect> <rect height=2 width=3 x=5 y=11></rect> <rect height=2 width=4 x=9 y=11></rect> </g> </svg>";
            var curTableCellIconSpans = $(curTableIconSpan.parentNode.childNodes[1]).children();
            curTableCellIconSpans.click((function () {
                var curQuillBetterTable = quill.getModule('better-table');
                var curQuillToolbar = quill.getModule('toolbar');
                return function () {
                    var curRowIndex = Number(this.dataset.value.substring(9).split('_')[0]);
                    var curColIndex = Number(this.dataset.value.substring(9).split('_')[1]);
                    curQuillBetterTable.insertTable(curRowIndex, curColIndex);
                    // The following two lines have been added, thinking that it would fix the issue of keeping the icon in blue color.  However Quill keeps adding the classes back, so this fix doesn't work.
                    $(this).parent().parent().find(".ql-selected").removeClass("ql-selected"); $(this).parent().parent().find(".ql-active").removeClass("ql-active");
                };
            })());
            curTableCellIconSpans.hover(function () {
                var curRowIndex = Number(this.dataset.value.substring(9).split('_')[0]);
                var curColIndex = Number(this.dataset.value.substring(9).split('_')[1]);
                $(this).parent().children().each((function () {
                    var curRowIndex1 = curRowIndex;
                    var curColIndex1 = curColIndex;
                    return function () {
                        var curRowIndex2 = Number(this.dataset.value.substring(9).split('_')[0]);
                        var curColIndex2 = Number(this.dataset.value.substring(9).split('_')[1]);
                        if (curRowIndex2 <= curRowIndex1 && curColIndex2 <= curColIndex1) {
                            $(this).addClass("ql-picker-item-highlight");
                        }
                    };
                })());
            }, function () {
                $(this).parent().children().removeClass("ql-picker-item-highlight");
            });

            // Add a custom Button to the Quill Editor's toolbar:
            const templateToolbarButton = new QuillToolbarButton({
                icon: '<img id="templateToolbarButton" style="height:20px" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAOEAAADhCAMAAAAJbSJIAAAAaVBMVEX/////wQf/vwD/24f/3Iz///3/vQD/ykL/yTj/yT3/0WH/0F7/0Fv/y0T/y0f/yTr/35T/wxT/8tP/6Lj/5az/7sj/9uX/46P/1G7/677/57P/2oL/xSj/8M//1nj//fb//O//4Zz/zVBsBjAmAAAEzklEQVR4nO2di3qiMBBGIUpa1168tFZ70933f8hl0KqVWCuZyfzhm/MAfJ7vhAmwCy0KwzAMwzAMwzAMwzAMwzAMWKq3QSzDyXymrXGe6ta7eLwvl8/aKmGqW1fy4Pz0SdsmAJ9g4zhaaAudwirYOIJl5Bas8QNtqWMEBLEURQRrRZiFKiRYK4KMGzHB0j1ouzXICdYR59p2haxg6d619YQF64gfPRcs3ae24KOsYOmmyoLCBUvtDSOBYOk176TEl2hjqHhdw1WwvuetOXcsN9ET5Cno/PJ1tvh4Gp9xdEM1QZ6C/m29O+Dmj4cyZCroV0fHfAkpahlyFfw+KEOKSoZcBU9//bh9WB1Dtn3w9MCbdkQVQ7Ztov3j71pH1jBk2+h9++n2UyuigiHfpZrftA7+AWDIeKnm162jL/QNOS+2Aw1n6oasF9uB83Cubch7uxS4qF4qz9JqxHq71L5/Xyvvh+z3g/40YjthUkOBG96TM7F9FiY1ZF6i25/vjhVXuvcWUv/4sl+o60/d+0OJglvF6XC2WS+eP53uPb7gUzV34TlNGkOxgpdJY5jiuaiqoWLBNIZJHvxqGuoKJjBUXaIpDDWHTBJD7YLihuoFxQ3VCwob6i9RacMbAEFJwwpCUNIQQ1DOEKSgoCHCkGkQMoQpKGUIsU3skDHEKShjiFRQxhCpoIQh0JBp4DcEE2Q3RCvIbwg1ZBp4DfEKMhtibRM7WA3vAQU5DRGXaMlqCFmQ0RC0IKMhqiCXYQW6REs2Q9iCXIa4BZkMgQvyGCIX5DCE3SZ2xBtiF4w3RC8YbwgvGGkIvNHviTPELxhpmEHBOMMcCkYZPmQh2H77q2cFS/dQ9bugu+laMIshE/Ntk1wEOxccB//POBzdC75lInjfVfC574LFNIuTMOIDSn+zSNh9yBRV3wsWrzkkjCgYeh8cj6iPmOWwSKMKBl4lhsPdd73YbsA/DeMKFsUEfZW6m6iCRTEAN4y4ksnDMLog+iqNLxh+XRqG2CHTgLxbcBSE3vFZChbBTzFhELnRH0A9EbkK1mirhGHYJvYEv/umDc+Q+eId70zkLFggbhi8BWsmYIqMQ+aLJZQie0EC6aG3GwkIFkX4W6EaMA8ZPEWBc/ALjIUqVpBAqChYkLhTV3QjwYKEdkXhgoRuRfGChGZF0SFzQG+iCm30bbQqJiqop5hgyBzQWKgJCxLpKyYtSKTeNJJsE99JWzF5QSJlRYWCRLqKiYfMgVQT1d0qCaaqqLRE0ym6R0XBFAtVWVC+ouoS3SK7aSgOmQOSFQEKEnIVIQoSUhVBChIyExWmICFREaggwa+ovg+ewr1Q4QS5K4It0S2cmwbUkDnAVxGyIMFVEbQgwVMRcMgc4JiowAWJ+IrQBYlYRfCCRNxCzUAwriL8Et3SfdPIoiDRtWImBYluFbMpSHSpmFFB4vqJmlVB4tqKmRUkrlPMriBxzULNUvCaihku0S2/3TQyLUj8rmK2BYnfVMy4IHG5YuaClydq9oKXKvZA8GfFXgj+tFB7Inj+hSLf+btqcEyCf7nXL7V/FyOz91ZGX660fxUvL+VxR+fdpDcrdM9q7Lx3jv7gtPv32j8/oprNJ8PB5HXWTz3DMAzDMAzDMAzDMAzDMHrEf9VjaGNa1FYRAAAAAElFTkSuQmCC"></img>'//`<svg viewBox="0 0 18 18"> <path class="ql-stroke" d="M5,3V9a4.012,4.012,0,0,0,4,4H9a4.012,4.012,0,0,0,4-4V3"></path></svg>`
            })

            templateToolbarButton.onClick = function (e) {
                var templateButton = document.getElementById('templateToolbarButton');
                var tl = getTemplates();
                if (tl.length > 0) {
                    showTemplateContextMenu(templateButton);
                } else {
                    createTemplate();
                }
            }
            templateToolbarButton.attach(quill)

            document.addEventListener('click', function (e) {
                if (isShowingTemplateMenu && clickCount > 0) {
                    hideTemplateContextMenu();
                } else {
                    clickCount++;
                    if (!wasLastClickOnTemplate) {
                        clearTemplateSelection();
                        //hidePasteTemplateToolbar();
                    } else if (!isShowingPasteTemplateToolbar) {
                        //showPasteTemplateToolbar();
                    }
                    wasLastClickOnTemplate = false;
                }
                return;
            });

            quill.on('selection-change', function (range, oldRange, source) {

                if (range) {
                    if (range.length == 0) {
                        console.log('User cursor is on', range.index);
                    } else {
                        var text = quill.getText(range.index, range.length);
                        console.log('User has highlighted', text);
                    }

                } else {
                    console.log('Cursor not in the editor');
                }
            });
        }

        function createTemplate(templateId) {
            var range = quill.getSelection(true);

            var tl = getTemplates();
            var newTemplateObj = {
                templateId: -(tl.length + 1),
                templateColor: getRandomColor(),
                templateName: quill.getText(range.index, range.length).trim()
            };
            var isNew = templateId == null;
            if (templateId != null) {
                for (var i = 0; i < tl.length; i++) {
                    var t = tl[i];
                    if (t['templateId'] == templateId) {
                        newTemplateObj = t;
                        break;
                    }
                }
            }
            if (range.length == 0 && templateId == null) {
                newTemplateObj['templateName'] = "Template #" + parseInt(tl.length + 1);
            }

            quill.deleteText(range.index, range.length);
            quill.insertEmbed(range.index, "templatespan", newTemplateObj, Quill.sources.API);
            var eofIdx = quill.getLength();
            if (range.index + newTemplateObj['templateName'].length >= eofIdx) {
                quill.insertText(range.index + 1, ' ', Quill.sources.API);
            }
            quill.setSelection(range.index + 1, Quill.sources.API);

            var tElml = document.getElementsByClassName("template_btn");
            for (var i = 0; i < tElml.length; i++) {
                var tElm = tElml[i];
                if (tElm.getAttribute('templateId') == newTemplateObj['templateId']) {
                    tElm.addEventListener('click', function (e) {
                        wasLastClickOnTemplate = true;
                        selectTemplate(tElm.getAttribute('templateId'), false);
                    });
                }
            }
            selectTemplate(newTemplateObj['templateId']);
        }

        function clearTemplateSelection() {
            var stl = document.getElementsByClassName("template_btn");
            for (var i = 0; i < stl.length; i++) {
                var t = stl[i];
                t.style.border = "";
            }
        }

        function selectTemplate(templateId, fromDropDown) {
            if (templateId == null) {
                return;
            }
            var stl = document.getElementsByClassName("template_btn");
            for (var i = 0; i < stl.length; i++) {
                var t = stl[i];
                if (t.getAttribute('templateid') == templateId) {
                    $('#templateTextArea').placeholder = "Enter text for " + t.innerText;
                    if (t.innerText != getTemplateById(templateId)['templateName']) {
                        $('#templateTextArea').val(t.innerText);
                    } else {
                        $('#templateTextArea').val('');
                    }
                    selectedTemplateId = templateId;
                    t.style.border = "2px solid red"
                } else {
                    t.style.border = "";
                }
            }
            if (fromDropDown == null || !fromDropDown) {
                var items = document.getElementById('custom-select').getElementsByTagName("div");
                for (var i = 0; i < items.length; i++) {
                    if (items[i].getAttribute('optionId') != null && items[i].getAttribute('optionId') == selectedTemplateId) {
                        //onTemplateOptionClick(null, items[i]);
                        eventFire(items[i], 'click');
                        break;
                    }
                }
            }
        }
        function eventFire(el, etype) {
            if (el.fireEvent) {
                el.fireEvent('on' + etype);
            } else {
                var evObj = document.createEvent('Events');
                evObj.initEvent(etype, true, false);
                el.dispatchEvent(evObj);
            }
        }

        function templateTextAreaChange() {
            var curText = $('#templateTextArea').val();
            setTemplateText(selectedTemplateId, curText);
        }

        function setTemplateText(templateId, text) {
            var stl = document.getElementsByClassName("template_btn");
            for (var i = 0; i < stl.length; i++) {
                var t = stl[i];
                if (t.getAttribute('templateid') == templateId) {
                    t.innerText = text;
                }
            }
        }

        function getTemplates() {
            var domTemplates = document.getElementsByClassName("template_btn");
            var templates = [];
            for (var i = 0; i < domTemplates.length; i++) {
                var domTemplate = domTemplates[i];
                var template = {
                    templateId: domTemplate.getAttribute('templateId'),
                    templateName: domTemplate.getAttribute('templateName'),
                    templateColor: domTemplate.getAttribute('templateColor'),
                    templateText: domTemplate.innerText
                }
                var isDup = false;
                for (var j = 0; j < templates.length; j++) {
                    if (templates[j]['templateId'] == template['templateId']) {
                        isDup = true;
                        break;
                    }
                }
                if (!isDup) {
                    templates.push(template);
                }
            }
            return templates;
        }

        function getTemplateById(templateId) {
            var tl = getTemplates();
            for (var i = 0; i < tl.length; i++) {
                var t = tl[i];
                if (t['templateId'] == templateId) {
                    return t;
                }
            }
            return null;
        }

        function showTemplateContextMenu(tb) {
            clickCount = 0;

            var rgtClickContextMenu = document.getElementById('templateToolbarMenu');
            var rgtClickContextMenuList = document.getElementById('templateToolbarMenuList');
            rgtClickContextMenuList.innerHTML = '';

            var tl = getTemplates();
            for (var i = 0; i < tl.length; i++) {
                var t = tl[i];
                var templateItem = '<li><a href="javascript:void(0);" onclick="createTemplate(' + t['templateId'] + ');">' +
                    '<div style="display:inline-block;margin: 0 5px 0 0;width: 15px; height: 15px;background-color:' + t['templateColor'] + '"></div>' +
                    '<span style="font-family:arial;">' + t['templateName'] + '</span></a></li>';
                rgtClickContextMenuList.innerHTML += templateItem;
            }

            rgtClickContextMenuList.innerHTML += '<li><a href="javascript:void(0);" onclick="createTemplate();">' +
                '<span style="margin: 0 5px 0 0;color:lightseagreen;font-size:20px">+</span>' +
                '<span style="font-family:arial;">Add Template</span></a></li>';
            const rect = tb.getBoundingClientRect();
            const x = rect.left + 20;
            const y = rect.bottom;
            rgtClickContextMenu.style.left = `${x}px`;
            rgtClickContextMenu.style.top = `${y}px`;
            rgtClickContextMenu.style.display = 'block';

            isShowingTemplateMenu = true;
        }

        function hideTemplateContextMenu() {
            var rgtClickContextMenu = document.getElementById('templateToolbarMenu');
            rgtClickContextMenu.style.display = 'none';

            isShowingTemplateMenu = false;
        }

        function showPasteTemplateToolbar() {
            var ptt = document.getElementById('pasteTemplateToolbar');
            ptt.style.display = 'inline-block';
            $('#pasteTemplateToolbar').css('top', $(".ql-toolbar").outerHeight());

            document.getElementById('custom-select').innerHTML = '<select id="pasteTemplateToolbarMenuSelector"></select >';

            var templateMenuSelector = document.getElementById('pasteTemplateToolbarMenuSelector');
            templateMenuSelector.innerHTML = '';

            var tl = getTemplates();
            for (var i = 0; i < tl.length; i++) {
                var t = tl[i];
                var templateItem = '<option class="templateOption" value="' + t['templateId'] + '" onchange="selectTemplate(' + t['templateId'] + ');">' +
                    t['templateName'] + '</option>';
                templateMenuSelector.innerHTML += templateItem;
            }


            document.getElementById('nextTemplateButton').addEventListener('click', function (e) {
                gotoNextTemplate();
            });

            document.getElementById('nextTemplateButton').addEventListener('keydown', function (e) {
                gotoNextTemplate();
            });

            document.getElementById('previousTemplateButton').addEventListener('click', function (e) {
                gotoPrevTemplate();
            });

            document.getElementById('previousTemplateButton').addEventListener('keydown', function (e) {
                gotoPrevTemplate();
            });

            document.getElementById('clearAllTemplateTextButton').addEventListener('click', function (e) {
                clearAllTemplateText();
            });
            document.getElementById('clearAllTemplateTextButton').addEventListener('keydown', function (e) {
                clearAllTemplateText();
            });

            document.getElementById('pasteTemplateButton').addEventListener('click', function (e) {
                isCompleted = true;
            });

            document.getElementById('pasteTemplateButton').addEventListener('keydown', function (e) {
                isCompleted = true;
            });

            createTemplateSelectorStyling(templateMenuSelector);

            //var viewportBottom = window.scrollY + window.innerHeight;
            //moveTemplateToolbarTop(viewportBottom);

            $("#editor").css("position", "absolute");
            $(".ql-toolbar").css("position", "absolute");
            $("#pasteTemplateToolbar").css("position", "absolute");

            let tbb = $(".ql-toolbar").outerHeight();
            //let eb = $("#editor").css("bottom");
            //
            $("#pasteTemplateToolbar").css("top", tbb);
            let pttbb = $(".ql-toolbar").outerHeight() + tbb;
            $("#editor").css("margin-top", pttbb);

            $('#templateTextArea').focus();

            isShowingPasteTemplateToolbar = true;
        }

        function gotoNextTemplate() {
            var curIdx = 0;
            for (var i = 0; i < tl.length; i++) {
                if (tl[i]['templateId'] == selectedTemplateId) {
                    curIdx = i;
                    break;
                }
            }
            var nextIdx = curIdx + 1;
            if (nextIdx >= tl.length) {
                nextIdx = 0;
            }
            selectTemplate(tl[nextIdx]['templateId']);
        }
        function gotoPrevTemplate() {
            var curIdx = 0;
            for (var i = 0; i < tl.length; i++) {
                if (tl[i]['templateId'] == selectedTemplateId) {
                    curIdx = i;
                    break;
                }
            }
            var prevIdx = curIdx - 1;
            if (prevIdx < 0) {
                prevIdx = tl.length - 1;
            }
            selectTemplate(tl[prevIdx]['templateId']);
        }

        function clearAllTemplateText() {
            var tl = getTemplates();
            for (var i = 0; i < tl.length; i++) {
                setTemplateText(tl[i]['templateId'], '');
            }
        }

        function createTemplateSelectorStyling() {
            var tl = getTemplates();
            var x, i, j, selElmnt, a, b, c;
            x = document.getElementsByClassName("custom-select");
            for (i = 0; i < x.length; i++) {
                selElmnt = x[i].getElementsByTagName("select")[0];
                var st = getTemplateById(selElmnt.options[selElmnt.selectedIndex].getAttribute('value'));
                a = document.createElement("DIV");
                a.setAttribute("class", "select-selected");
                a2 = document.createElement("SPAN");
                a2.setAttribute("class", "square-box");
                a2.setAttribute("style", "background-color: " + st['templateColor']);
                a.appendChild(a2);
                a.innerHTML += '<span style="margin: 0 10px 0 50px;">' + selElmnt.options[selElmnt.selectedIndex].innerHTML + '</span>';
                x[i].appendChild(a);
                b = document.createElement("DIV");
                b.setAttribute("class", "select-items select-hide");
                for (j = 0; j < selElmnt.length; j++) {
                    var t = getTemplateById(selElmnt.options[j].getAttribute('value'));
                    c = document.createElement("DIV");
                    c.setAttribute('optionId', parseInt(t['templateId']));
                    //c.innerHTML = selElmnt.options[j].innerHTML;
                    d = document.createElement("SPAN");
                    d.setAttribute("class", "square-box");
                    d.setAttribute("style", "background-color: " + t['templateColor']);
                    c.appendChild(d);
                    c.innerHTML += selElmnt.options[j].innerHTML;
                    c.addEventListener("click", onTemplateOptionClick);
                    b.appendChild(c);
                    if (j == selElmnt.selectedIndex) {
                        c.classList.add("class", "same-as-selected");
                    }
                }
                x[i].appendChild(b);
                a.addEventListener("click", function (e) {
                    e.stopPropagation();
                    closeAllSelect(this);
                    this.nextSibling.classList.toggle("select-hide");
                    this.classList.toggle("select-arrow-active");
                });

            }

            function closeAllSelect(elmnt) {
                var x, y, i, arrNo = [];
                x = document.getElementsByClassName("select-items");
                y = document.getElementsByClassName("select-selected");
                for (i = 0; i < y.length; i++) {
                    if (elmnt == y[i]) {
                        arrNo.push(i)
                    } else {
                        y[i].classList.remove("select-arrow-active");
                    }
                }
                for (i = 0; i < x.length; i++) {
                    if (arrNo.indexOf(i)) {
                        x[i].classList.add("select-hide");
                    }
                }
            }
            document.addEventListener("click", closeAllSelect);
        }

        function onTemplateOptionClick(e, target) {
            var targetDiv = e == null ? target : e.currentTarget;
            var tVal = parseInt(targetDiv.getAttribute('optionId'));
            var t = getTemplateById(tVal);
            var y, i, k, s, h;
            s = targetDiv.parentNode.parentNode.getElementsByTagName("select")[0];
            h = targetDiv.parentNode.previousSibling;
            for (i = 0; i < s.length; i++) {
                var sVal = parseInt(s.options[i].value);
                if (sVal == tVal) {
                    s.selectedIndex = i;
                    h.innerHTML = targetDiv.innerHTML.replace(t['templateName'], '<span style="margin: 0 10px 0 50px;">' + t['templateName'] + '</span>');
                    y = targetDiv.parentNode.getElementsByClassName("same-as-selected");
                    for (k = 0; k < y.length; k++) {
                        y[k].removeAttribute("class");
                    }
                    targetDiv.setAttribute("class", "same-as-selected");
                    break;
                }
            }

            selectTemplate(s.options[s.selectedIndex].value, true);
            h.click();
        }

        function hidePasteTemplateToolbar() {
            var ptt = document.getElementById('pasteTemplateToolbar');
            ptt.style.display = 'none';
            isShowingPasteTemplateToolbar = false;
        }

        function getFontName(font) {
            // Generate code-friendly font names
            return font.toLowerCase().replace(/\s/g, "-");
        }

        function setText(text) {
            quill.setText(text + '\n');
        }

        function setHtml(html) {
            //var delta = quill.clipboard.convert(html);
            //quill.setContents(delta, 'silent');
            quill.root.innerHTML = html;
        }

        function getText() {
            var text = quill.getText(0, quill.getLength() - 1);
            return text;
        }

        function getHtml() {
            //document.getElementsByClassName
            //var val = document.getElementsByClassName("ql-editor")[0].innerHTML;
            clearTemplateSelection();
            var val = quill.root.innerHTML;
            return unescape(val);
        }

        function getTemplatesJson() {
            var val = JSON.stringify(getTemplates());
            return val;
        }

        function decodeHtml(html) {
            var txt = document.createElement("textarea");
            txt.innerHTML = html;
            return txt.value;
        }

        function getRandomColor() {
            var letters = '0123456789ABCDEF';
            var color = '#';
            for (var i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }

        function isBright(hex, brightThreshold = 150) {
            var c = hexToRgb(hex.toLowerCase());
            var grayVal = Math.sqrt(
                (c.R * 1) * (c.R * 1) * .299 +
                (c.G * 1) * (c.G * 1) * .587 +
                (c.B * 1) * (c.B * 1) * .114);
            return grayVal > brightThreshold;
        }
        function hexToRgb(hex) {
            var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                R: parseInt(result[1], 16),
                G: parseInt(result[2], 16),
                B: parseInt(result[3], 16)
            } : null;
        }

        function createTemplateSpan(templateName) {
            var range = quill.getSelection(true);
            if (range) {
                quill.deleteText(range.index, range.length);
                var ts = '<span style="border-style:solid;border-color:orange;border-radius:10px;padding:15px;background-color:purple;color:white;font-size:15em">&lt;' + templateName + '&gt;</span>';
                quill.clipboard.dangerouslyPasteHTML(range.index, ts);

                console.log('text:\n' + getText());
                console.table('\nhtml:\n' + getHtml());
            }
        }

        function createLink() {
            var range = quill.getSelection(true);
            if (range) {
                var text = quill.getText(range.index, range.length);
                quill.deleteText(range.index, range.length);
                var ts = '<a class="square_btn" href="https://www.google.com">' + text + '</a>';
                quill.clipboard.dangerouslyPasteHTML(range.index, ts);

                console.log('text:\n' + getText());
                console.table('\nhtml:\n' + getHtml());
            }
        }

        function moveToolbarTop(y) {
            $("#editor").css("position", "absolute");
            $(".ql-toolbar").css("position", "absolute");

            var viewportBottom = window.scrollY + window.innerHeight;
            let tbh = $(".ql-toolbar").outerHeight();
            if (y <= 0) {
                //keyboard is not visible
                $(".ql-toolbar").css("top", y);
                $("#editor").css("top", y + tbh);
            } else {
                $(".ql-toolbar").css("top", y - tbh);
                $("#editor").css("top", 0);
            }
            $("#editor").css("bottom", viewportBottom - tbh);
        }

        function moveTemplateToolbarTop(y) {
            $("#editor").css("position", "absolute");
            $(".ql-toolbar").css("position", "absolute");
            $("#pasteTemplateToolbar").css("position", "absolute");

            let tbh = $("#pasteTemplateToolbar").outerHeight();
            //let eb = $("#editor").css("bottom");
            // $("#editor").css("bottom", eb - tbh);
            $("#pasteTemplateToolbar").css("top", y - tbh - 20);
        }
                    //==================================================================================================
        init(null, null, null, null, null);
    </script>

</body>
</html>

