<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title>Yo this is a title</title>
    <link href="https://cdn.quilljs.com/2.0.0-dev.4/quill.snow.css"
          rel="stylesheet" />
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.2/styles/github.min.css" />
    <link type="text/css" href="https://unpkg.com/quill-better-table@1.2.7/dist/quill-better-table.css" rel="stylesheet" />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.2/highlight.min.js"></script>
    <script charset="UTF-8"
            src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.2/languages/xml.min.js"></script>
    <script src="https://cdn.quilljs.com/2.0.0-dev.4/quill.min.js"></script>


    <script src="https://cdn.quilljs.com/2.0.0-dev.3/quill.js"></script>
    <script src="https://unpkg.com/quill-better-table@1.2.8/dist/quill-better-table.min.js"></script>
    <link type="text/css" href="https://cdn.quilljs.com/2.0.0-dev.3/quill.snow.css" rel="stylesheet">
    <link type="text/css" href="https://unpkg.com/quill-better-table@1.2.7/dist/quill-better-table.css" rel="stylesheet" />

    <script src="https://unpkg.com/quill-better-table@1.2.8/dist/quill-better-table.min.js"></script>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>

    <style>
        body {
            margin: 0px;
            padding: 0px;
        }

        .btn {
            border: none;
            background-color: green;
            padding: 14px 28px;
            font-size: 16px;
            cursor: pointer;
            display: inline-block;
        }

            /* On mouse-over */
            .btn:hover {
                background: #eee;
            }

        .success {
            color: green;
        }

        .ql-omega:after {
            content: "Ω";
        }

        span.template {
            border-style: solid;
            border-color: white;
            border-radius: 10px;
            padding: 7px;
            background-color: purple;
            color: white;
            text-align: center;
            font-size: medium;
        }

        /* maps font sizes to font drop down*/
        .ql-snow
        .ql-picker.ql-size
        .ql-picker-label[data-value]::before,
        .ql-snow .ql-picker.ql-size
        .ql-picker-item[data-value]::before {
            content: attr(data-value) !important;
        }

        /* Table Styles*/
        .ql-snow .ql-Table-Input .ql-picker-options {
            padding: 3px 5px;
            width: 152px;
        }

        .ql-snow .ql-Table-Input .ql-picker-item {
            border: 1px solid transparent;
            float: left;
            height: 16px;
            margin: 2px;
            padding: 0px;
            width: 16px;
            background: lightsteelblue;
        }

            .ql-snow .ql-Table-Input .ql-picker-item:hover, .ql-snow .ql-Table-Input .ql-picker-item.ql-picker-item-highlight {
                border-color: #000;
                background: steelblue;
            }

        .ql-snow .ql-Table-Input.ql-picker {
            width: 28px;
        }

            .ql-snow .ql-Table-Input.ql-picker .ql-picker-label {
                padding: 2px 4px;
            }
    </style>
</head>
<body>
    <div id='editor'>
    </div>

    <script src="https://cdn.polyfill.io/v2/polyfill.min.js?features=Promise"
            crossorigin="anonymous"></script>
    <script src="https://benwinding.github.io/quill-html-edit-button/dist/quill.htmlEditButton.min.js"></script>
    <script type="text/javascript">        
        var curQuillDiv = $("#editor");
        var quill;

        function init(html, fontFamilys, fontSizes, defaultFontIdx, indentSize) {
            if (fontFamilys == null) {
                fontFamilys = ['Arial', 'Courier', 'Garamond', 'Tahoma', 'Times New Roman', 'Verdana'];
            }
            if (fontSizes == null) {
                fontSizes = ['8px', '9px', '10px', '12px', '14px', '16px', '20px', '24px', '32px', '42px', '54px', '68px', '84px', '98px'];
            }
            if (defaultFontIdx == null) {
                defaultFontIdx = 0;
            }
            loadQuill(fontFamilys, fontSizes, defaultFontIdx);

            if (html != null) {
                setHtml(html);
            }
        }

        function loadTable() {
            var tableOptions = [];
            var maxRows = 7;
            var maxCols = 7;

            for (let r = 1; r <= maxRows; r++) {
                for (let c = 1; c <= maxCols; c++) {
                    tableOptions.push('newtable_' + r + '_' + c);
                }
            }
            return tableOptions;
        }

        function loadToolbar(fontFamilys, fontSizes, defaultFontIdx) {
            var fonts = loadFonts(fontFamilys);

            var toolbarOptions2 = [
                [{ header: [1, 2, 3, false] }],
                [{ 'font': fonts.whitelist }],
                ['bold', 'italic', 'underline'],
                ['clean']
                ["image"],
            ];

            var toolbarOptions = [
                //[{ 'size': ['small', false, 'large', 'huge'] }],  // custom dropdown
                [{ 'size': fontSizes }],               // font sizes
                [{ 'font': fonts.whitelist }],
                ['bold', 'italic', 'underline'/*, 'strike'*/],        // toggled buttons
                //['blockquote', 'code-block'],

                // [{ 'header': 1 }, { 'header': 2 }],               // custom button values
                [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                // [{ 'script': 'sub' }, { 'script': 'super' }],      // superscript/subscript
                [{ 'indent': '-1' }, { 'indent': '+1' }],          // outdent/indent
                //[{ 'direction': 'rtl' }],                         // text direction

                // [{ 'header': [1, 2, 3, 4, 5, 6, false] }],

                [{ 'color': [] }, { 'background': [] }],          // dropdown with defaults from theme
                [{ 'align': [] }],
                // ['clean'],                                         // remove formatting button
                ['omega'],

                [{ 'Table-Input': loadTable() }]
            ];

            return toolbarOptions;
        }

        function loadFonts(fontFamilys, fontSizes, defaultFontIdx) {
            // Specify Quill fonts
            var fontNames = fontFamilys.map(font => getFontName(font));
            var fonts = Quill.import('attributors/class/font');
            fonts.whitelist = fontNames;
            Quill.register(fonts, true);

            //font sizes
            var size = Quill.import('attributors/style/size');
            size.whitelist = fontSizes;
            Quill.register(size, true);

            return fonts;
        }

        function loadFontStyles(fontFamilys) {
            // Add fonts to CSS style
            var fontStyles = "";
            fontFamilys.forEach(function (font) {
                var fontName = getFontName(font);
                fontStyles += ".ql-snow .ql-picker.ql-font .ql-picker-label[data-value=" + fontName + "]::before, .ql-snow .ql-picker.ql-font .ql-picker-item[data-value=" + fontName + "]::before {" +
                    "content: '" + font + "';" +
                    "font-family: '" + font + "', sans-serif;" +
                    "}" +
                    ".ql-font-" + fontName + "{" +
                    " font-family: '" + font + "', sans-serif;" +
                    "}";
            });

            return fontStyles;
        }

        function loadQuill(fontFamilys, fontSizes, defaultFontIdx, indentSize) {
            Quill.register("modules/htmlEditButton", htmlEditButton);
            Quill.register({ 'modules/better-table': quillBetterTable }, true);

            // Append the CSS stylesheet to the page
            var node = document.createElement('style');
            node.innerHTML = loadFontStyles(fontFamilys);
            document.body.appendChild(node);

            quill = new Quill(curQuillDiv[0], {
                placeholder: 'Compose your text...',
                theme: 'snow',
                modules: {
                    toolbar: loadToolbar(fontFamilys, fontSizes, defaultFontIdx),
                    htmlEditButton: {
                        syntax: true,
                    },
                    table: false,
                    'better-table': {
                        operationMenu: {
                            items: {
                                unmergeCells: {
                                    text: 'Unmerge cells'
                                }
                            },
                            color: {
                                colors: ['green', 'red', 'yellow', 'blue', 'white'],
                                text: 'Background Colors:'
                            }
                        }
                    },
                    keyboard: {
                        bindings: quillBetterTable.keyboardBindings
                    }
                }
            });


            var curTableIconSpan = curQuillDiv.parent().find('span.ql-Table-Input.ql-picker')[0].childNodes[0];
            curTableIconSpan.innerHTML = "<svg style=\"right: 4px;\" viewbox=\"0 0 18 18\"> <rect class=ql-stroke height=12 width=12 x=3 y=3></rect> <rect class=ql-fill height=2 width=3 x=5 y=5></rect> <rect class=ql-fill height=2 width=4 x=9 y=5></rect> <g class=\"ql-fill ql-transparent\"> <rect height=2 width=3 x=5 y=8></rect> <rect height=2 width=4 x=9 y=8></rect> <rect height=2 width=3 x=5 y=11></rect> <rect height=2 width=4 x=9 y=11></rect> </g> </svg>";
            var curTableCellIconSpans = $(curTableIconSpan.parentNode.childNodes[1]).children();
            curTableCellIconSpans.click((function () {
                var curQuillBetterTable = quill.getModule('better-table');
                var curQuillToolbar = quill.getModule('toolbar');
                return function () {
                    var curRowIndex = Number(this.dataset.value.substring(9).split('_')[0]);
                    var curColIndex = Number(this.dataset.value.substring(9).split('_')[1]);
                    curQuillBetterTable.insertTable(curRowIndex, curColIndex);
                    // The following two lines have been added, thinking that it would fix the issue of keeping the icon in blue color.  However Quill keeps adding the classes back, so this fix doesn't work.
                    $(this).parent().parent().find(".ql-selected").removeClass("ql-selected"); $(this).parent().parent().find(".ql-active").removeClass("ql-active");
                };
            })());
            curTableCellIconSpans.hover(function () {
                var curRowIndex = Number(this.dataset.value.substring(9).split('_')[0]);
                var curColIndex = Number(this.dataset.value.substring(9).split('_')[1]);
                $(this).parent().children().each((function () {
                    var curRowIndex1 = curRowIndex;
                    var curColIndex1 = curColIndex;
                    return function () {
                        var curRowIndex2 = Number(this.dataset.value.substring(9).split('_')[0]);
                        var curColIndex2 = Number(this.dataset.value.substring(9).split('_')[1]);
                        if (curRowIndex2 <= curRowIndex1 && curColIndex2 <= curColIndex1) {
                            $(this).addClass("ql-picker-item-highlight");
                        }
                    };
                })());


            }, function () {
                $(this).parent().children().removeClass("ql-picker-item-highlight");
            });

            var toolbar = quill.getModule('toolbar');
            toolbar.addHandler('omega', function () {
                console.log('omega')
            });


            var customButton = document.querySelector('.ql-omega');
            customButton.addEventListener('click', function () {
                var range = quill.getSelection();
                if (range) {
                    //var sIdx = range.index > 0 ? range.index - 1 : 0;
                    //let delta = quill.getContents();

                    //const a = delta.retain(sIdx).delete(range.length).insert('POOOP');

                    //var ops = [
                    //    { retain: sIdx },
                    //    { delete: range.length },
                    //    { insert: 'POOOP' }
                    //];

                    //quill.updateContents(ops);
                    //quill.insertText(range.index, "Ω");
                    //setSelectionContent('pooopy');
                    //setSelection(range.index, range.index + range.length);

                    //createTemplateSpan('New Template #1');
                    createLink();
                }
            });
        }

        function getFontName(font) {
            // Generate code-friendly font names
            return font.toLowerCase().replace(/\s/g, "-");
        }

        function setText(text) {
            quill.setText(text + '\n');
        }

        function setHtml(html) {
            //var delta = quill.clipboard.convert(html);
            //quill.setContents(delta, 'silent');
            quill.root.innerHTML = html;
        }

        function getText() {
            var text = quill.getText(0, quill.getLength() - 1);
            return text;
        }

        function getHtml() {
            //document.getElementsByClassName
            //var val = document.getElementsByClassName("ql-editor")[0].innerHTML;
            var val = quill.root.innerHTML;
            return val;
        }

        function createTemplateSpan(templateName) {
            var range = quill.getSelection(true);
            if (range) {
                quill.deleteText(range.index, range.length);
                var ts = '<span style="border-style:solid;border-color:orange;border-radius:10px;padding:15px;background-color:purple;color:white;font-size:15em">&lt;' + templateName + '&gt;</span>';
                quill.clipboard.dangerouslyPasteHTML(range.index, ts);

                console.log('text:\n' + getText());
                console.table('\nhtml:\n' + getHtml());
            }
        }

        function createLink() {
            var range = quill.getSelection(true);
            if (range) {
                var text = quill.getText(range.index, range.length);
                quill.deleteText(range.index, range.length);
                var ts = '<a href="https://www.google.com">' + text + '</a>';
                quill.clipboard.dangerouslyPasteHTML(range.index, ts);

                console.log('text:\n' + getText());
                console.table('\nhtml:\n' + getHtml());
            }
        }
            //==================================================================================================

    </script>

</body>
</html>

