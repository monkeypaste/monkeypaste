-- Tag Ancestors----------------------------

WITH RECURSIVE
  tag_ancestor(n) AS (
    VALUES(5)
    UNION 
    SELECT fk_ParentTagId FROM MpTag, tag_ancestor
     WHERE MpTag.pk_MpTagId=tag_ancestor.n
  )
SELECT fk_ParentTagId FROM MpTag
 WHERE MpTag.pk_MpTagId IN tag_ancestor AND fk_ParentTagId > 0;
 
 ------------------------------------------------
 
 -- Tag Descendants---------------------
 
 WITH RECURSIVE
  tag_descendant(n) AS (
    VALUES(4)
    UNION 
    SELECT MpTag.pk_MpTagId FROM MpTag, tag_descendant
     WHERE fk_ParentTagId=tag_descendant.n
  )
SELECT MpTag.pk_MpTagId FROM MpTag
 WHERE fk_ParentTagId IN tag_descendant AND fk_ParentTagId > 0;
 
 -- Tag Self And Descendants------------------------------------
 
  WITH RECURSIVE
  tag_descendant(n) AS (
    VALUES(4)
    UNION 
    SELECT MpTag.pk_MpTagId FROM MpTag, tag_descendant
     WHERE fk_ParentTagId=tag_descendant.n
  )
SELECT 4 UNION ALL SELECT MpTag.pk_MpTagId FROM MpTag
 WHERE fk_ParentTagId IN tag_descendant AND fk_ParentTagId > 0;
 
 --Tag Self and Descendant CopyItem Count -----------------------------------------------------
WITH RECURSIVE
  tag_descendant(n) AS (
    VALUES(4)
    UNION 
    SELECT MpTag.pk_MpTagId FROM MpTag, tag_descendant
     WHERE fk_ParentTagId=tag_descendant.n
  )
SELECT COUNT(DISTINCT fk_MpCopyItemId) FROM MpCopyItemTag WHERE fk_MpTagId IN
(SELECT 4 UNION ALL SELECT MpTag.pk_MpTagId FROM MpTag
 WHERE fk_ParentTagId IN tag_descendant AND fk_ParentTagId > 0); 
 
 -- Unlinked CopyItems
 
 WITH RECURSIVE
  tag_descendant(n) AS (
    VALUES(1)
    UNION 
    SELECT MpTag.pk_MpTagId FROM MpTag, tag_descendant
     WHERE fk_ParentTagId=tag_descendant.n
  )
select * from MpCopyItem where pk_MpCopyItemId not in (
SELECT distinct fk_MpCopyItemId FROM MpCopyItemTag WHERE fk_MpTagId IN
(SELECT 1 UNION ALL SELECT MpTag.pk_MpTagId FROM MpTag
 WHERE fk_ParentTagId IN tag_descendant AND fk_ParentTagId > 0));